<!DOCTYPE html>
<html lang="hi" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Business Management System ‚Äî Single File</title>
  <style>
    /* THEME */
    :root { --radius: 12px; --shadow: 0 10px 30px rgba(0,0,0,.25); --ring: rgba(16,185,129,.45); }
    /* Dark */
    html[data-theme="dark"]{
      --bg:#0b0b0b; --surface:#121212; --muted:#2a2a2a; --muted-2:#1a1a1a; --card:#0f0f0f;
      --text:#eaeaea; --text-soft:#a3a3a3; --primary:#10b981; --primary-600:#059669;
      --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444; --border:#262626;
    }
    /* Light */
    html[data-theme="light"]{
      --bg:#f8fafc; --surface:#ffffff; --muted:#e5e7eb; --muted-2:#e5e7eb; --card:#ffffff;
      --text:#111827; --text-soft:#6b7280; --primary:#0ea5e9; --primary-600:#0284c7;
      --ok:#16a34a; --warn:#d97706; --danger:#dc2626; --border:#e5e7eb;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: "Roboto", "Inter", system-ui, -apple-system, "Segoe UI", "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
      background:var(--bg); color:var(--text);
    }

    /* Layout */
    .app{
      display:grid;
      grid-template-columns: 280px 1fr;
      grid-template-rows: 64px 1fr;
      grid-template-areas:
        "sidebar header"
        "sidebar main";
      height:100vh;
      gap:12px;
      padding:12px;
    }
    nav.sidebar{
      grid-area:sidebar;
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:12px;
      display:flex;flex-direction:column;gap:10px;overflow:auto;
    }
    header{
      grid-area:header;
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:0 14px;
      display:flex;align-items:center;justify-content:space-between;
    }
    main{
      grid-area:main;
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;overflow:auto;
    }

    /* Sidebar */
    .brand{
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;border-radius:10px;
      background:linear-gradient(135deg, rgba(16,185,129,.18), transparent 60%);
    }
    .logo{
      width:32px;height:32px;border-radius:8px;
      background:linear-gradient(135deg,var(--primary),var(--primary-600));
      color:white;font-weight:900;display:grid;place-items:center;
      box-shadow:0 6px 16px rgba(16,185,129,.35), inset 0 0 0 2px rgba(255,255,255,.15);
    }
    .menu{display:flex;flex-direction:column;gap:6px}
    .menu button{
      all:unset;display:flex;align-items:center;gap:10px;cursor:pointer;
      padding:10px 12px;border-radius:10px;color:var(--text);border:1px solid transparent;
    }
    .menu button:hover{background:rgba(127,127,127,.08);border-color:rgba(127,127,127,.15)}
    .menu button.active{background:rgba(16,185,129,.15);border-color:rgba(16,185,129,.25)}
    .tag{margin-left:auto;font-size:12px;padding:2px 8px;border-radius:999px;background:rgba(127,127,127,.12);color:var(--text-soft)}

    /* Header */
    .searchbar{position:relative;flex:1;max-width:620px;margin:0 12px}
    .searchbar input{
      width:100%;padding:10px 12px 10px 40px;border-radius:10px;border:1px solid var(--border);
      background:var(--card);color:var(--text);outline:none;
    }
    .searchbar input:focus{border-color:var(--primary);box-shadow:0 0 0 4px var(--ring)}
    .searchbar .icon{position:absolute;left:12px;top:50%;transform:translateY(-50%);opacity:.6}
    .header-actions{display:flex;align-items:center;gap:8px}
    .btn,.btn-ghost{
      all:unset;display:inline-flex;align-items:center;gap:8px;cursor:pointer;
      padding:10px 12px;border-radius:10px;border:1px solid var(--border);
      background:var(--card);color:var(--text);font-weight:600;
    }
    .btn:hover{border-color:var(--primary);box-shadow:0 0 0 4px var(--ring)}
    .btn.primary{background:linear-gradient(135deg,var(--primary),var(--primary-600));color:white;border-color:transparent}
    .btn.primary:hover{box-shadow:0 0 0 4px var(--ring), 0 8px 28px rgba(16,185,129,.35)}
    .btn-ghost{background:transparent;color:var(--text-soft)}
    .btn-ghost:hover{background:rgba(127,127,127,.08);color:var(--text)}

    /* Sections */
    .section{display:none}
    .section.active{display:block}
    .section-title{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
    .muted{color:var(--text-soft);font-size:14px}

    /* Cards & Panels */
    .cards{display:grid;grid-template-columns:repeat(12,1fr);gap:12px;margin-bottom:16px}
    .card{grid-column:span 3;background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px}
    .card-title{color:var(--text-soft);font-size:13px}
    .card-value{font-size:24px;font-weight:800;margin-top:6px}
    .card-trend{font-size:12px;margin-top:6px;display:flex;align-items:center;gap:6px}
    .trend-up{color:var(--ok)} .trend-down{color:var(--danger)}
    .panel{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}

    /* Tables */
    .table-wrap{overflow:auto;border:1px solid var(--border);border-radius:12px}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{
      position:sticky;top:0;z-index:1;background:var(--surface);
      text-align:left;padding:12px 10px;font-weight:700;font-size:13px;border-bottom:1px solid var(--border);cursor:pointer
    }
    tbody td{padding:12px 10px;border-bottom:1px solid rgba(127,127,127,.15);font-size:14px}
    tbody tr:hover{background:rgba(127,127,127,.08)}
    .actions{display:flex;gap:6px;flex-wrap:wrap}
    .icon-btn{all:unset;cursor:pointer;padding:6px 10px;border-radius:8px;border:1px solid var(--border);color:var(--text-soft)}
    .icon-btn:hover{color:var(--text);border-color:var(--primary)}
    .danger{color:#fecaca;border-color:rgba(239,68,68,.35)}
    .danger:hover{background:rgba(239,68,68,.12)}
    .badge{padding:4px 10px;border-radius:999px;font-size:12px;border:1px solid rgba(127,127,127,.2);background:rgba(127,127,127,.08)}
    .b-ok{background:rgba(34,197,94,.15);border-color:rgba(34,197,94,.3)}
    .b-warn{background:rgba(245,158,11,.15);border-color:rgba(245,158,11,.3)}
    .b-bad{background:rgba(239,68,68,.15);border-color:rgba(239,68,68,.3)}

    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    .input,.select,.textarea{
      width:100%;max-width:280px;padding:10px 12px;border-radius:10px;border:1px solid var(--border);
      background:var(--card);color:var(--text);outline:none
    }
    .textarea{min-height:84px;resize:vertical}
    .input:focus,.select:focus,.textarea:focus{border-color:var(--primary);box-shadow:0 0 0 4px var(--ring)}

    /* Modals */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
    .modal.open{display:flex;background:rgba(0,0,0,.6)}
    .modal-card{width:100%;max-width:760px;background:var(--surface);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);overflow:hidden}
    .modal-header{display:flex;justify-content:space-between;align-items:center;padding:14px;border-bottom:1px solid var(--border)}
    .modal-body{padding:14px}
    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .form-grid .full{grid-column:1/-1}
    label{font-size:13px;color:var(--text-soft);display:block;margin:6px 2px}
    .footer{display:flex;justify-content:flex-end;gap:8px;padding:14px;border-top:1px solid var(--border)}

    /* Toasts */
    .toast-wrap{position:fixed;right:16px;bottom:16px;display:flex;flex-direction:column;gap:8px;z-index:60}
    .toast{background:var(--surface);border:1px solid var(--border);border-left:4px solid var(--primary);padding:10px 12px;border-radius:12px;box-shadow:var(--shadow);min-width:220px}
    .toast.warn{border-left-color:var(--warn)} .toast.danger{border-left-color:var(--danger)}

    /* Chart */
    .chart-wrap{height:300px}
    .chart-wrap canvas{width:100%;height:100%;display:block}

    /* Responsive */
    @media (max-width: 1200px){
      .cards .card{grid-column: span 6}
      .grid-2{grid-template-columns:1fr}
      .app{grid-template-columns: 1fr; grid-template-areas: "header" "main"; padding-top:76px}
      nav.sidebar{position:fixed;left:12px;top:12px;right:12px;height:56px;display:flex;flex-direction:row;align-items:center;gap:8px;overflow:auto}
      .brand{margin:0}
      .menu{flex-direction:row;flex:1;overflow:auto}
      .tag{display:none}
    }
    @media (max-width: 640px){
      .cards .card{grid-column: span 12}
      .input,.select,.textarea,.btn{max-width:100%}
      .form-grid{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="app">
    <nav class="sidebar" aria-label="Sidebar">
      <div class="brand">
        <div class="logo">B</div>
        <div style="font-weight:800">Business Manager</div>
      </div>
      <div class="menu" role="tablist" aria-label="Modules">
        <button class="active" role="tab" data-tab="dashboard">üìä Dashboard</button>
        <button role="tab" data-tab="clients">üßë‚Äçüíº Clients <span class="tag" id="count-clients">0</span></button>
        <button role="tab" data-tab="expenses">üí∏ Expenses <span class="tag" id="count-expenses">0</span></button>
        <button role="tab" data-tab="payments">üí≥ Payments <span class="tag" id="count-payments">0</span></button>
        <button role="tab" data-tab="employees">üë• Employees <span class="tag" id="count-employees">0</span></button>
      </div>
    </nav>

    <header>
      <div class="searchbar" role="search">
        <span class="icon">üîé</span>
        <input id="globalSearch" type="search" placeholder="Search clients, expenses, payments, employees..." />
      </div>
      <div class="header-actions">
        <button id="themeToggle" class="btn-ghost">üåì Theme</button>
        <button id="exportBtn" class="btn-ghost">‚¨áÔ∏è Export</button>
        <button id="resetBtn" class="btn-ghost">‚Ü∫ Reset</button>
        <button id="quickAddBtn" class="btn primary">Ôºã Quick Add</button>
      </div>
    </header>

    <main>
      <section id="view-dashboard" class="section active" aria-labelledby="heading-dashboard">
        <div class="section-title">
          <div>
            <h2 id="heading-dashboard">Dashboard</h2>
            <div class="muted">Income, Expenses, Profit and Status-wise tracking</div>
          </div>
        </div>

        <div class="cards">
          <div class="card">
            <div class="card-title">Income (Paid)</div>
            <div class="card-value" id="kpi-income">‚Çπ0.00</div>
            <div class="card-trend"><span class="trend-up">‚ñ≤</span><span id="kpi-income-trend">+0% vs last month</span></div>
          </div>
          <div class="card">
            <div class="card-title">Expenses</div>
            <div class="card-value" id="kpi-expenses">‚Çπ0.00</div>
            <div class="card-trend"><span class="trend-down">‚ñº</span><span id="kpi-expenses-trend">+0% vs last month</span></div>
          </div>
          <div class="card">
            <div class="card-title">Profit</div>
            <div class="card-value" id="kpi-profit">‚Çπ0.00</div>
            <div class="card-trend"><span class="muted">Income - Expenses</span></div>
          </div>
          <div class="card">
            <div class="card-title">Total Records</div>
            <div class="card-value" id="kpi-records">0</div>
            <div class="card-trend muted">Clients ‚Ä¢ Expenses ‚Ä¢ Payments ‚Ä¢ Employees</div>
          </div>
        </div>

        <div class="grid-2">
          <div class="panel">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <div>
                <strong>Monthly Income vs Expenses</strong>
                <div class="muted">Last 12 months (auto-updates)</div>
              </div>
            </div>
            <div class="chart-wrap">
              <canvas id="monthlyChart" role="img" aria-label="Income vs Expenses"></canvas>
            </div>
          </div>

          <div class="panel">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <div>
                <strong>Status-wise Tracking</strong>
                <div class="muted">Current ‚Ä¢ Pending ‚Ä¢ Complete ‚Ä¢ Cancelled</div>
              </div>
              <button class="btn-ghost" data-tab-jump="payments">Manage ‚Üí</button>
            </div>
            <div id="statusStats" style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px"></div>
            <div class="table-wrap" style="margin-top:12px">
              <table>
                <thead><tr><th>Client</th><th>Service</th><th>Cost</th><th>Status</th></tr></thead>
                <tbody id="statusTableBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <section id="view-clients" class="section" aria-labelledby="heading-clients">
        <div class="section-title">
          <div>
            <h2 id="heading-clients">Clients</h2>
            <div class="muted">Name, Company, Contact, Service & Cost, Added Date</div>
          </div>
          <div><button class="btn" data-open="modal-client">Ôºã Add Client</button></div>
        </div>

        <div class="controls">
          <input id="clientSearch" class="input" type="search" placeholder="Search clients..." />
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th data-sort="name">Client</th>
                <th data-sort="company">Company</th>
                <th>Contact</th>
                <th data-sort="service">Service</th>
                <th data-sort="cost">Cost</th>
                <th data-sort="added">Added</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="clientTableBody"></tbody>
          </table>
        </div>
      </section>

      <section id="view-expenses" class="section" aria-labelledby="heading-expenses">
        <div class="section-title">
          <div>
            <h2 id="heading-expenses">Expenses</h2>
            <div class="muted">Date, Detail, Amount, Linked Client</div>
          </div>
          <div><button class="btn" data-open="modal-expense">Ôºã Add Expense</button></div>
        </div>

        <div class="controls">
          <input id="expenseSearch" class="input" type="search" placeholder="Search expenses..." />
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th data-sort="date">Date</th>
                <th>Detail</th>
                <th data-sort="amount">Amount</th>
                <th data-sort="clientName">Linked Client</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="expenseTableBody"></tbody>
          </table>
        </div>
      </section>

      <section id="view-payments" class="section" aria-labelledby="heading-payments">
        <div class="section-title">
          <div>
            <h2 id="heading-payments">Client Payments</h2>
            <div class="muted">Payment status/date, pending reason, service status</div>
          </div>
          <div><button class="btn" data-open="modal-payment">Ôºã Add Payment</button></div>
        </div>

        <div class="controls">
          <input id="paymentSearch" class="input" type="search" placeholder="Search payments..." />
          <select id="paymentStatusFilter" class="select">
            <option value="">All Payment Status</option>
            <option>Paid</option>
            <option>Pending</option>
          </select>
          <select id="serviceStatusFilter" class="select">
            <option value="">All Service Status</option>
            <option>Current</option>
            <option>Pending</option>
            <option>Complete</option>
            <option>Cancelled</option>
          </select>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th data-sort="clientName">Client</th>
                <th>Company</th>
                <th>Contact</th>
                <th data-sort="service">Service</th>
                <th data-sort="cost">Cost</th>
                <th data-sort="paymentStatus">Payment</th>
                <th data-sort="paymentDate">Payment Date</th>
                <th>Pending Reason</th>
                <th data-sort="serviceStatus">Service Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="paymentTableBody"></tbody>
          </table>
        </div>
      </section>

      <section id="view-employees" class="section" aria-labelledby="heading-employees">
        <div class="section-title">
          <div>
            <h2 id="heading-employees">Employees</h2>
            <div class="muted">Name, Skills/Work, Contact, Client Work Handle</div>
          </div>
          <div><button class="btn" data-open="modal-employee">Ôºã Add Employee</button></div>
        </div>

        <div class="controls">
          <input id="employeeSearch" class="input" type="search" placeholder="Search employees..." />
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th data-sort="name">Name</th>
                <th>Skills / Work</th>
                <th>Contact</th>
                <th data-sort="clientName">Client Handle</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="employeeTableBody"></tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

   MODALS 
  <div class="modal" id="modal-client" aria-hidden="true" role="dialog" aria-labelledby="modal-client-title">
    <div class="modal-card">
      <div class="modal-header">
        <strong id="modal-client-title">Add Client</strong>
        <button class="icon-btn" data-close="modal-client">‚úñÔ∏è</button>
      </div>
      <form id="clientForm">
        <div class="modal-body">
          <input type="hidden" name="id" />
          <div class="form-grid">
            <div>
              <label>Client Name</label>
              <input class="input" name="name" required placeholder="Full name" />
            </div>
            <div>
              <label>Company</label>
              <input class="input" name="company" placeholder="Company name" />
            </div>
            <div class="full">
              <label>Contact info</label>
              <input class="input" name="contact" placeholder="email or phone" />
            </div>
            <div>
              <label>Service Name</label>
              <input class="input" name="service" placeholder="Service" />
            </div>
            <div>
              <label>Service Cost (‚Çπ)</label>
              <input class="input" type="number" min="0" step="0.01" name="cost" placeholder="0.00" />
            </div>
            <div>
              <label>Added Date</label>
              <input class="input" type="date" name="added" />
            </div>
          </div>
        </div>
        <div class="footer">
          <button type="button" class="btn-ghost" data-close="modal-client">Cancel</button>
          <button class="btn primary" type="submit">Save</button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal" id="modal-expense" aria-hidden="true" role="dialog" aria-labelledby="modal-expense-title">
    <div class="modal-card">
      <div class="modal-header">
        <strong id="modal-expense-title">Add Expense</strong>
        <button class="icon-btn" data-close="modal-expense">‚úñÔ∏è</button>
      </div>
      <form id="expenseForm">
        <div class="modal-body">
          <input type="hidden" name="id" />
          <div class="form-grid">
            <div>
              <label>Date</label>
              <input class="input" type="date" name="date" required />
            </div>
            <div>
              <label>Amount (‚Çπ)</label>
              <input class="input" type="number" min="0" step="0.01" name="amount" required placeholder="0.00" />
            </div>
            <div class="full">
              <label>Detail</label>
              <input class="input" name="detail" placeholder="Expense detail" />
            </div>
            <div class="full">
              <label>Linked Client (optional)</label>
              <select class="select" name="clientId" id="expenseClientSelect">
                <option value="">‚Äî None ‚Äî</option>
              </select>
            </div>
          </div>
        </div>
        <div class="footer">
          <button type="button" class="btn-ghost" data-close="modal-expense">Cancel</button>
          <button class="btn primary" type="submit">Save</button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal" id="modal-payment" aria-hidden="true" role="dialog" aria-labelledby="modal-payment-title">
    <div class="modal-card">
      <div class="modal-header">
        <strong id="modal-payment-title">Add Payment</strong>
        <button class="icon-btn" data-close="modal-payment">‚úñÔ∏è</button>
      </div>
      <form id="paymentForm">
        <div class="modal-body">
          <input type="hidden" name="id" />
          <div class="form-grid">
            <div>
              <label>Client</label>
              <select class="select" name="clientId" id="paymentClientSelect">
                <option value="">‚Äî Select client ‚Äî</option>
              </select>
            </div>
            <div>
              <label>Company</label>
              <input class="input" name="company" placeholder="Company name" />
            </div>
            <div class="full">
              <label>Contact</label>
              <input class="input" name="contact" placeholder="email or phone" />
            </div>
            <div>
              <label>Service</label>
              <input class="input" name="service" placeholder="Service name" />
            </div>
            <div>
              <label>Cost (‚Çπ)</label>
              <input class="input" type="number" min="0" step="0.01" name="cost" placeholder="0.00" />
            </div>
            <div>
              <label>Payment Status</label>
              <select class="select" name="paymentStatus">
                <option>Paid</option>
                <option>Pending</option>
              </select>
            </div>
            <div>
              <label>Payment Date</label>
              <input class="input" type="date" name="paymentDate" />
            </div>
            <div class="full">
              <label>Pending Reason</label>
              <input class="input" name="pendingReason" placeholder="Reason if pending" />
            </div>
            <div>
              <label>Service Status</label>
              <select class="select" name="serviceStatus">
                <option>Current</option>
                <option>Pending</option>
                <option>Complete</option>
                <option>Cancelled</option>
              </select>
            </div>
          </div>
        </div>
        <div class="footer">
          <button type="button" class="btn-ghost" data-close="modal-payment">Cancel</button>
          <button class="btn primary" type="submit">Save</button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal" id="modal-employee" aria-hidden="true" role="dialog" aria-labelledby="modal-employee-title">
    <div class="modal-card">
      <div class="modal-header">
        <strong id="modal-employee-title">Add Employee</strong>
        <button class="icon-btn" data-close="modal-employee">‚úñÔ∏è</button>
      </div>
      <form id="employeeForm">
        <div class="modal-body">
          <input type="hidden" name="id" />
          <div class="form-grid">
            <div>
              <label>Name</label>
              <input class="input" name="name" required placeholder="Full name" />
            </div>
            <div>
              <label>Contact</label>
              <input class="input" name="contact" placeholder="email or phone" />
            </div>
            <div class="full">
              <label>Skills / Work</label>
              <input class="input" name="skills" placeholder="Skills / Role" />
            </div>
            <div class="full">
              <label>Client Work Handle</label>
              <select class="select" name="clientId" id="employeeClientSelect">
                <option value="">‚Äî None ‚Äî</option>
              </select>
            </div>
          </div>
        </div>
        <div class="footer">
          <button type="button" class="btn-ghost" data-close="modal-employee">Cancel</button>
          <button class="btn primary" type="submit">Save</button>
        </div>
      </form>
    </div>
  </div>

   Toasts 
  <div id="toasts" class="toast-wrap" aria-live="polite" aria-atomic="true"></div>

  <script>
    // ===== Utilities =====
    const byId = (id)=>document.getElementById(id);
    const fmt = (n)=>'‚Çπ'+Number(n||0).toLocaleString('en-IN',{minimumFractionDigits:2,maximumFractionDigits:2});
    const toast = (msg,type='')=>{
      const wrap = byId('toasts'); const el=document.createElement('div');
      el.className='toast '+(type||''); el.textContent=msg; wrap.appendChild(el);
      setTimeout(()=>{ el.style.opacity='0'; el.style.transform='translateY(10px)'; }, 2400);
      setTimeout(()=>{ wrap.removeChild(el); }, 3000);
    };
    const openModal=(id)=>{ const el=byId(id); if(el){ el.classList.add('open'); el.setAttribute('aria-hidden','false'); }};
    const closeModal=(id)=>{ const el=byId(id); if(el){ el.classList.remove('open'); el.setAttribute('aria-hidden','true'); }};
    const uid=(()=>{ let i=1000; return ()=> (++i).toString(); })();

    // ===== Local Persistence (no backend) =====
    const LS_KEY='bms-local-v1';
    const SS_MIGRATION_KEY='bms-session-v2'; // migrate once if present

    const saveState=()=>{
      try{
        localStorage.setItem(LS_KEY, JSON.stringify({
          theme: document.documentElement.getAttribute('data-theme')||'dark',
          clients: state.clients, expenses: state.expenses, payments: state.payments, employees: state.employees
        }));
      }catch(e){ console.warn('save failed', e); }
    };
    const loadState=()=>{
      try{
        const raw=localStorage.getItem(LS_KEY);
        if(raw) return JSON.parse(raw);
        // migrate from old sessionStorage if exists
        const ssRaw = sessionStorage.getItem(SS_MIGRATION_KEY);
        if(ssRaw){
          localStorage.setItem(LS_KEY, ssRaw);
          return JSON.parse(ssRaw);
        }
        return null;
      }catch(e){ console.warn('load failed', e); return null; }
    };

    // ===== Defaults =====
    const defaults = {
      clients:[
        {id:'c1',name:'Amit Sharma',company:'Acme Pvt Ltd',contact:'+91-9876543210',service:'Website Redesign',cost:85000,added:new Date().toISOString().slice(0,10)},
        {id:'c2',name:'Neha Kapoor',company:'Kapoor & Co',contact:'neha@example.com',service:'SEO Retainer',cost:20000,added:new Date().toISOString().slice(0,10)}
      ],
      expenses:[
        {id:'e1',date:new Date(new Date().setMonth(new Date().getMonth()-1)).toISOString().slice(0,10),detail:'Software Subscriptions',amount:5000,clientId:''},
        {id:'e2',date:new Date().toISOString().slice(0,10),detail:'Team Lunch',amount:2200,clientId:'c1'}
      ],
      payments:[
        {id:'p1',clientId:'c1',clientName:'Amit Sharma',company:'Acme Pvt Ltd',contact:'+91-9876543210',service:'Website Redesign',cost:85000,paymentStatus:'Paid',paymentDate:new Date().toISOString().slice(0,10),pendingReason:'',serviceStatus:'Current'},
        {id:'p2',clientId:'c2',clientName:'Neha Kapoor',company:'Kapoor & Co',contact:'neha@example.com',service:'SEO Retainer',cost:20000,paymentStatus:'Pending',paymentDate:'',pendingReason:'Awaiting approval',serviceStatus:'Pending'}
      ],
      employees:[
        {id:'m1',name:'Rahul Verma',skills:'Frontend Engineer',contact:'rahul@example.com',clientId:'c1'},
        {id:'m2',name:'Priya Nair',skills:'SEO Specialist',contact:'+91-9000000000',clientId:'c2'}
      ],
      theme:'dark'
    };

    const persisted=loadState();
    if(persisted?.theme) document.documentElement.setAttribute('data-theme', persisted.theme);

    // ===== State =====
    const state = {
      clients: persisted?.clients ?? [...defaults.clients],
      expenses: persisted?.expenses ?? [...defaults.expenses],
      payments: persisted?.payments ?? [...defaults.payments],
      employees: persisted?.employees ?? [...defaults.employees],
      sort:{
        clients:{key:'name',dir:'asc'},
        expenses:{key:'date',dir:'desc'},
        payments:{key:'clientName',dir:'asc'},
        employees:{key:'name',dir:'asc'}
      },
      filters:{
        client:'', expense:'',
        payment:{ q:'', paymentStatus:'', serviceStatus:'' },
        employee:''
      }
    };

    // ===== Helpers =====
    const getClient=(id)=> state.clients.find(c=>c.id===id);
    const clientName=(id)=> getClient(id)?.name || '';
    const sumIncomePaid=()=> state.payments.filter(p=>p.paymentStatus==='Paid').reduce((s,p)=>s+Number(p.cost||0),0);
    const sumExpenses=()=> state.expenses.reduce((s,e)=>s+Number(e.amount||0),0);
    function groupMonthly(list, getDate, getAmount, months=12){
      const now=new Date(), out=[];
      for(let i=months-1;i>=0;i--){
        const d=new Date(now.getFullYear(), now.getMonth()-i, 1);
        const label=d.toLocaleString('en-US',{month:'short'});
        const val=list.filter(row=>{
          const raw=getDate(row)||'';
          const dt=raw ? new Date(raw) : null;
          return dt && dt.getFullYear()===d.getFullYear() && dt.getMonth()===d.getMonth();
        }).reduce((s,row)=> s + Number(getAmount(row)||0), 0);
        out.push({label,value:val});
      }
      return out;
    }
    function statusCounts(){
      const base={Current:0, Pending:0, Complete:0, Cancelled:0};
      state.payments.forEach(p=>{ if(base[p.serviceStatus]!==undefined) base[p.serviceStatus]++; });
      return base;
    }

    // ===== Theme =====
    function toggleTheme(){
      const cur=document.documentElement.getAttribute('data-theme')||'dark';
      document.documentElement.setAttribute('data-theme', cur==='dark'?'light':'dark');
      saveState();
    }

    // ===== Render =====
    function renderSidebarCounts(){
      byId('count-clients').textContent = state.clients.length;
      byId('count-expenses').textContent = state.expenses.length;
      byId('count-payments').textContent = state.payments.length;
      byId('count-employees').textContent = state.employees.length;
    }

    function renderDashboard(){
      const income=sumIncomePaid(), expenses=sumExpenses(), profit=income-expenses;
      byId('kpi-income').textContent = fmt(income);
      byId('kpi-expenses').textContent = fmt(expenses);
      byId('kpi-profit').textContent = fmt(profit);
      byId('kpi-records').textContent = state.clients.length + state.expenses.length + state.payments.length + state.employees.length;

      const inc2=groupMonthly(state.payments.filter(p=>p.paymentStatus==='Paid' && p.paymentDate), p=>p.paymentDate, p=>p.cost, 2);
      const exp2=groupMonthly(state.expenses, e=>e.date, e=>e.amount, 2);
      const lastI=inc2[inc2.length-1]?.value || 0, prevI=inc2.length>1 ? inc2[inc2.length-2].value : 0;
      const lastE=exp2[exp2.length-1]?.value || 0, prevE=exp2.length>1 ? exp2[exp2.length-2].value : 0;
      const dI = prevI? Math.round(((lastI-prevI)/prevI)*100) : (lastI>0?100:0);
      const dE = prevE? Math.round(((lastE-prevE)/prevE)*100) : (lastE>0?100:0);
      byId('kpi-income-trend').textContent = (dI>=0?'+':'')+dI+'% vs last month';
      byId('kpi-expenses-trend').textContent = (dE>=0?'+':'')+dE+'% vs last month';

      drawMonthlyChart();

      const stats=statusCounts();
      const wrap=byId('statusStats'); wrap.innerHTML='';
      Object.entries(stats).forEach(([k,v])=>{
        const card=document.createElement('div'); card.className='card'; card.style.gridColumn='span 1';
        card.innerHTML = `<div class="card-title">${k}</div><div class="card-value">${v}</div>`;
        wrap.appendChild(card);
      });
      const tbody=byId('statusTableBody'); tbody.innerHTML='';
      state.payments.slice(0,8).forEach(p=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${p.clientName || clientName(p.clientId) || '‚Äî'}</td>
          <td>${p.service||'‚Äî'}</td>
          <td>${fmt(p.cost||0)}</td>
          <td><span class="badge ${p.serviceStatus==='Complete'?'b-ok':p.serviceStatus==='Cancelled'?'b-bad':'b-warn'}">${p.serviceStatus}</span></td>
        `;
        tbody.appendChild(tr);
      });
    }

    function drawMonthlyChart(){
      try{
        const canvas=byId('monthlyChart');
        if(!canvas) return;
        const parent=canvas.parentElement;
        const ctx=canvas.getContext('2d');
        const dpr = window.devicePixelRatio || 1;
        const displayW = (canvas.clientWidth || parent.clientWidth || 600);
        const displayH = (canvas.clientHeight || parent.clientHeight || 300);
        canvas.width = Math.max(300, Math.floor(displayW * dpr));
        canvas.height = Math.max(150, Math.floor(displayH * dpr));
        ctx.setTransform(1,0,0,1,0,0);
        ctx.scale(dpr, dpr);

        const incomeData = groupMonthly(state.payments.filter(p=>p.paymentStatus==='Paid' && p.paymentDate), p=>p.paymentDate, p=>p.cost, 12);
        const expenseData = groupMonthly(state.expenses, e=>e.date, e=>e.amount, 12);

        const padding={l:44,r:16,t:16,b:36};
        const W = displayW - padding.l - padding.r;
        const H = displayH - padding.t - padding.b;
        const max = Math.max(1, ...incomeData.map(d=>d.value), ...expenseData.map(d=>d.value));

        ctx.clearRect(0,0,displayW,displayH);
        const soft = getComputedStyle(document.documentElement).getPropertyValue('--text-soft').trim() || 'rgba(127,127,127,.7)';
        ctx.strokeStyle = soft; ctx.globalAlpha = 0.35;
        ctx.beginPath(); ctx.moveTo(padding.l, padding.t); ctx.lineTo(padding.l, padding.t+H); ctx.lineTo(padding.l+W, padding.t+H); ctx.stroke();
        ctx.globalAlpha = 1;

        const slot = W / incomeData.length;
        const barW = Math.max(8, slot * 0.34);

        incomeData.forEach((d, i)=>{
          const xCenter = padding.l + i*slot + slot/2;
          const incH = (d.value / max) * (H - 8);
          const expVal = expenseData[i]?.value || 0;
          const expH = (expVal / max) * (H - 8);

          // income
          const y1 = padding.t + H - incH;
          const grad = ctx.createLinearGradient(0,y1,0,y1+incH);
          const pcol = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#10b981';
          grad.addColorStop(0,pcol); grad.addColorStop(1,'rgba(16,185,129,.3)');
          ctx.fillStyle = grad;
          ctx.fillRect(xCenter - barW - 3, y1, barW, Math.max(0, incH));

          // expense
          const y2 = padding.t + H - expH;
          ctx.fillStyle = 'rgba(239,68,68,.85)';
          ctx.fillRect(xCenter + 3, y2, barW, Math.max(0, expH));

          // x labels
          ctx.fillStyle = soft; ctx.font = '12px system-ui'; ctx.textAlign='center';
          ctx.fillText(d.label, xCenter, padding.t + H + 20);
        });

        // y labels
        ctx.fillStyle = soft; ctx.font='11px system-ui'; ctx.textAlign='right';
        ctx.fillText(fmt(max), padding.l-6, padding.t+10);
        ctx.fillText('0', padding.l-6, padding.t+H);
      }catch(e){ console.warn('chart error', e); }
    }

    // List renders
    function renderClients(){
      const q=(state.filters.client||'').toLowerCase();
      const rows=state.clients.filter(c=>[c.name,c.company,c.contact,c.service].join(' ').toLowerCase().includes(q));
      const {key,dir}=state.sort.clients;
      rows.sort((a,b)=>{
        if(key==='cost') return dir==='asc' ? (a.cost||0)-(b.cost||0) : (b.cost||0)-(a.cost||0);
        if(key==='added') return dir==='asc' ? (a.added||'').localeCompare(b.added||'') : (b.added||'').localeCompare(a.added||'');
        const av=(a[key]||'').toString(), bv=(b[key]||'').toString();
        return dir==='asc' ? av.localeCompare(bv) : bv.localeCompare(av);
      });
      const tbody=byId('clientTableBody'); tbody.innerHTML='';
      rows.forEach(c=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${c.name}</td>
          <td>${c.company||'‚Äî'}</td>
          <td class="muted">${c.contact||'‚Äî'}</td>
          <td>${c.service||'‚Äî'}</td>
          <td>${fmt(c.cost||0)}</td>
          <td>${c.added||'‚Äî'}</td>
          <td class="actions">
            <button class="icon-btn" data-action="edit-client" data-id="${c.id}">‚úèÔ∏è Edit</button>
            <button class="icon-btn danger" data-action="delete-client" data-id="${c.id}">üóëÔ∏è Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }
    function renderExpenses(){
      const q=(state.filters.expense||'').toLowerCase();
      const rows=state.expenses.filter(e=> [e.detail, clientName(e.clientId)].join(' ').toLowerCase().includes(q));
      const {key,dir}=state.sort.expenses;
      rows.sort((a,b)=>{
        if(key==='date') return dir==='asc' ? (a.date||'').localeCompare(b.date||'') : (b.date||'').localeCompare(a.date||'');
        if(key==='amount') return dir==='asc' ? (a.amount||0)-(b.amount||0) : (b.amount||0)-(a.amount||0);
        if(key==='clientName') return dir==='asc' ? clientName(a.clientId).localeCompare(clientName(b.clientId)) : clientName(b.clientId).localeCompare(clientName(a.clientId));
        return 0;
      });
      const tbody=byId('expenseTableBody'); tbody.innerHTML='';
      rows.forEach(e=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${e.date}</td>
          <td>${e.detail||'‚Äî'}</td>
          <td>${fmt(e.amount||0)}</td>
          <td>${clientName(e.clientId)||'‚Äî'}</td>
          <td class="actions">
            <button class="icon-btn" data-action="edit-expense" data-id="${e.id}">‚úèÔ∏è Edit</button>
            <button class="icon-btn danger" data-action="delete-expense" data-id="${e.id}">üóëÔ∏è Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }
    function renderPayments(){
      const {q,paymentStatus,serviceStatus}=state.filters.payment;
      const s=(q||'').toLowerCase();
      let rows=state.payments.filter(p=>{
        const m=[p.clientName,p.company,p.contact,p.service].join(' ').toLowerCase().includes(s);
        const ps=!paymentStatus || p.paymentStatus===paymentStatus;
        const ss=!serviceStatus || p.serviceStatus===serviceStatus;
        return m && ps && ss;
      });
      const {key,dir}=state.sort.payments;
      rows.sort((a,b)=>{
        if(key==='cost') return dir==='asc' ? (a.cost||0)-(b.cost||0) : (b.cost||0)-(a.cost||0);
        if(key==='paymentDate') return dir==='asc' ? (a.paymentDate||'').localeCompare(b.paymentDate||'') : (b.paymentDate||'').localeCompare(a.paymentDate||'');
        const av=(a[key]||'').toString(), bv=(b[key]||'').toString();
        return dir==='asc' ? av.localeCompare(bv) : bv.localeCompare(av);
      });
      const tbody=byId('paymentTableBody'); tbody.innerHTML='';
      rows.forEach(p=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${p.clientName || clientName(p.clientId) || '‚Äî'}</td>
          <td>${p.company||'‚Äî'}</td>
          <td class="muted">${p.contact||'‚Äî'}</td>
          <td>${p.service||'‚Äî'}</td>
          <td>${fmt(p.cost||0)}</td>
          <td><span class="badge ${p.paymentStatus==='Paid'?'b-ok':'b-warn'}">${p.paymentStatus}</span></td>
          <td>${p.paymentStatus==='Paid' ? (p.paymentDate||'‚Äî') : '‚Äî'}</td>
          <td>${p.paymentStatus==='Pending' ? (p.pendingReason||'‚Äî') : '‚Äî'}</td>
          <td><span class="badge ${p.serviceStatus==='Complete'?'b-ok':p.serviceStatus==='Cancelled'?'b-bad':'b-warn'}">${p.serviceStatus}</span></td>
          <td class="actions">
            <button class="icon-btn" data-action="edit-payment" data-id="${p.id}">‚úèÔ∏è Edit</button>
            <button class="icon-btn danger" data-action="delete-payment" data-id="${p.id}">üóëÔ∏è Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }
    function renderEmployees(){
      const q=(state.filters.employee||'').toLowerCase();
      const rows=state.employees.filter(m=> [m.name,m.skills,m.contact, clientName(m.clientId)].join(' ').toLowerCase().includes(q));
      const {key,dir}=state.sort.employees;
      rows.sort((a,b)=>{
        if(key==='name') return dir==='asc' ? (a.name||'').localeCompare(b.name||'') : (b.name||'').localeCompare(a.name||'');
        if(key==='clientName') return dir==='asc' ? clientName(a.clientId).localeCompare(clientName(b.clientId)) : clientName(b.clientId).localeCompare(clientName(a.clientId));
        return 0;
      });
      const tbody=byId('employeeTableBody'); tbody.innerHTML='';
      rows.forEach(m=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${m.name}</td>
          <td>${m.skills||'‚Äî'}</td>
          <td class="muted">${m.contact||'‚Äî'}</td>
          <td>${clientName(m.clientId)||'‚Äî'}</td>
          <td class="actions">
            <button class="icon-btn" data-action="edit-employee" data-id="${m.id}">‚úèÔ∏è Edit</button>
            <button class="icon-btn danger" data-action="delete-employee" data-id="${m.id}">üóëÔ∏è Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Populate selects
    function fillClientSelects(){
      const opts = '<option value="">‚Äî None ‚Äî</option>' + state.clients.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
      byId('expenseClientSelect').innerHTML = opts;
      byId('employeeClientSelect').innerHTML = opts;
      const pay = '<option value="">‚Äî Select client ‚Äî</option>' + state.clients.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
      byId('paymentClientSelect').innerHTML = pay;
    }

    // Tabs
    function activateTab(tab){
      document.querySelectorAll('.menu button').forEach(b=>{
        const on = b.getAttribute('data-tab')===tab;
        b.classList.toggle('active', on);
        b.setAttribute('aria-selected', on?'true':'false');
      });
      document.querySelectorAll('.section').forEach(s=>{
        s.classList.toggle('active', s.id === 'view-'+tab);
      });
      if(tab==='dashboard') renderDashboard();
      if(tab==='clients') renderClients();
      if(tab==='expenses') renderExpenses();
      if(tab==='payments') renderPayments();
      if(tab==='employees') renderEmployees();
    }

    // Wiring
    function wire(){
      // Tabs
      document.querySelectorAll('.menu button[role="tab"]').forEach(btn=>{
        btn.addEventListener('click', ()=> activateTab(btn.getAttribute('data-tab')));
      });
      document.querySelectorAll('[data-tab-jump]').forEach(el=>{
        el.addEventListener('click', ()=> activateTab(el.getAttribute('data-tab-jump')));
      });

      // Open/Close modals
      document.querySelectorAll('[data-open]').forEach(el=>{
        el.addEventListener('click', ()=> openModal(el.getAttribute('data-open')));
      });
      document.querySelectorAll('[data-close]').forEach(el=>{
        el.addEventListener('click', ()=> closeModal(el.getAttribute('data-close')));
      });
      document.querySelectorAll('.modal').forEach(m=>{
        m.addEventListener('click', (e)=>{ if(e.target===m) closeModal(m.id); });
      });

      // Theme + Export + QuickAdd + Reset
      byId('themeToggle').addEventListener('click', toggleTheme);
      byId('exportBtn').addEventListener('click', ()=>{
        const blob=new Blob([JSON.stringify({
          theme:document.documentElement.getAttribute('data-theme')||'dark',
          clients:state.clients,expenses:state.expenses,payments:state.payments,employees:state.employees
        },null,2)], {type:'application/json'});
        const url=URL.createObjectURL(blob); const a=document.createElement('a');
        a.href=url; a.download='bms-data.json'; a.click(); URL.revokeObjectURL(url);
      });
      byId('resetBtn').addEventListener('click', ()=>{
        if(!confirm('Reset all data to defaults?')) return;
        localStorage.removeItem(LS_KEY);
        location.reload();
      });
      byId('quickAddBtn').addEventListener('click', ()=>{
        const f=byId('clientForm'); f.reset(); f.querySelector('[name="id"]').value='';
        byId('modal-client-title').textContent='Add Client'; openModal('modal-client');
      });

      // Global search
      byId('globalSearch').addEventListener('keydown', (e)=>{
        if(e.key!=='Enter') return;
        const q=(e.target.value||'').trim().toLowerCase();
        const hitPay=state.payments.some(p=>[p.clientName,p.company,p.contact,p.service].join(' ').toLowerCase().includes(q));
        const hitCli=state.clients.some(c=>[c.name,c.company,c.contact,c.service].join(' ').toLowerCase().includes(q));
        const hitExp=state.expenses.some(x=>[x.detail, clientName(x.clientId)].join(' ').toLowerCase().includes(q));
        const hitEmp=state.employees.some(x=>[x.name,x.skills,x.contact, clientName(x.clientId)].join(' ').toLowerCase().includes(q));
        if(hitPay) activateTab('payments'); else if(hitCli) activateTab('clients'); else if(hitExp) activateTab('expenses'); else if(hitEmp) activateTab('employees'); else activateTab('dashboard');
        if(hitCli){ state.filters.client=q; byId('clientSearch').value=q; renderClients(); }
        if(hitExp){ state.filters.expense=q; byId('expenseSearch').value=q; renderExpenses(); }
        if(hitPay){ state.filters.payment.q=q; byId('paymentSearch').value=q; renderPayments(); }
        if(hitEmp){ state.filters.employee=q; byId('employeeSearch').value=q; renderEmployees(); }
      });

      // Clients
      byId('clientSearch').addEventListener('input', e=>{ state.filters.client=e.target.value; renderClients(); });
      document.querySelector('#view-clients thead').addEventListener('click', e=>{
        const key=e.target.getAttribute('data-sort'); if(!key) return;
        const s=state.sort.clients; s.dir=(s.key===key && s.dir==='asc')?'desc':'asc'; s.key=key; renderClients();
      });
      byId('clientTableBody').addEventListener('click', e=>{
        const btn=e.target.closest('button[data-action]'); if(!btn) return;
        const id=btn.getAttribute('data-id'); const action=btn.getAttribute('data-action');
        if(action==='edit-client'){
          const c=state.clients.find(x=>x.id===id);
          const f=byId('clientForm'); f.reset();
          f.querySelector('[name="id"]').value=c.id;
          f.querySelector('[name="name"]').value=c.name;
          f.querySelector('[name="company"]').value=c.company||'';
          f.querySelector('[name="contact"]').value=c.contact||'';
          f.querySelector('[name="service"]').value=c.service||'';
          f.querySelector('[name="cost"]').value=c.cost||0;
          f.querySelector('[name="added"]').value=c.added||'';
          byId('modal-client-title').textContent='Edit Client'; openModal('modal-client');
        }
        if(action==='delete-client'){
          if(!confirm('Delete this client?')) return;
          const used = state.expenses.some(x=>x.clientId===id) || state.payments.some(p=>p.clientId===id) || state.employees.some(m=>m.clientId===id);
          if(used){ toast('Cannot delete: linked to expenses/payments/employees','warn'); return; }
          state.clients = state.clients.filter(c=>c.id!==id);
          toast('Client deleted'); saveState(); fillClientSelects(); renderClients(); renderSidebarCounts(); renderDashboard();
        }
      });
      byId('clientForm').addEventListener('submit', e=>{
        e.preventDefault();
        const fd=new FormData(e.target);
        const id=fd.get('id');
        const obj={
          id: id || ('c'+uid()),
          name: (fd.get('name')||'').toString().trim(),
          company: (fd.get('company')||'').toString().trim(),
          contact: (fd.get('contact')||'').toString().trim(),
          service: (fd.get('service')||'').toString().trim(),
          cost: Number(fd.get('cost')||0),
          added: (fd.get('added')||'').toString()
        };
        if(!obj.name) return toast('Client name required','warn');
        if(id){ const i=state.clients.findIndex(c=>c.id===id); state.clients[i]=obj; toast('Client updated'); }
        else { state.clients.unshift(obj); toast('Client added'); }
        saveState(); closeModal('modal-client'); fillClientSelects(); renderClients(); renderSidebarCounts(); renderDashboard();
      });

      // Expenses
      byId('expenseSearch').addEventListener('input', e=>{ state.filters.expense=e.target.value; renderExpenses(); });
      document.querySelector('#view-expenses thead').addEventListener('click', e=>{
        const key=e.target.getAttribute('data-sort'); if(!key) return;
        const s=state.sort.expenses; s.dir=(s.key===key && s.dir==='asc')?'desc':'asc'; s.key=key; renderExpenses();
      });
      byId('expenseTableBody').addEventListener('click', e=>{
        const btn=e.target.closest('button[data-action]'); if(!btn) return;
        const id=btn.getAttribute('data-id'); const action=btn.getAttribute('data-action');
        if(action==='edit-expense'){
          const x=state.expenses.find(v=>v.id===id);
          const f=byId('expenseForm'); f.reset();
          f.querySelector('[name="id"]').value=x.id;
          f.querySelector('[name="date"]').value=x.date;
          f.querySelector('[name="amount"]').value=x.amount;
          f.querySelector('[name="detail"]').value=x.detail||'';
          f.querySelector('[name="clientId"]').value=x.clientId||'';
          byId('modal-expense-title').textContent='Edit Expense'; openModal('modal-expense');
        }
        if(action==='delete-expense'){
          if(!confirm('Delete this expense?')) return;
          state.expenses = state.expenses.filter(v=>v.id!==id);
          toast('Expense deleted'); saveState(); renderExpenses(); renderSidebarCounts(); renderDashboard();
        }
      });
      byId('expenseForm').addEventListener('submit', e=>{
        e.preventDefault();
        const fd=new FormData(e.target);
        const id=fd.get('id');
        const obj={
          id: id || ('e'+uid()),
          date: (fd.get('date')||'').toString(),
          amount: Number(fd.get('amount')||0),
          detail: (fd.get('detail')||'').toString().trim(),
          clientId: (fd.get('clientId')||'').toString()
        };
        if(!obj.date) return toast('Expense date required','warn');
        if(id){ const i=state.expenses.findIndex(v=>v.id===id); state.expenses[i]=obj; toast('Expense updated'); }
        else { state.expenses.unshift(obj); toast('Expense added'); }
        saveState(); closeModal('modal-expense'); renderExpenses(); renderSidebarCounts(); renderDashboard();
      });

      // Payments
      byId('paymentSearch').addEventListener('input', e=>{ state.filters.payment.q=e.target.value; renderPayments(); });
      byId('paymentStatusFilter').addEventListener('change', e=>{ state.filters.payment.paymentStatus=e.target.value; renderPayments(); });
      byId('serviceStatusFilter').addEventListener('change', e=>{ state.filters.payment.serviceStatus=e.target.value; renderPayments(); });
      document.querySelector('#view-payments thead').addEventListener('click', e=>{
        const key=e.target.getAttribute('data-sort'); if(!key) return;
        const s=state.sort.payments; s.dir=(s.key===key && s.dir==='asc')?'desc':'asc'; s.key=key; renderPayments();
      });
      byId('paymentTableBody').addEventListener('click', e=>{
        const btn=e.target.closest('button[data-action]'); if(!btn) return;
        const id=btn.getAttribute('data-id'); const action=btn.getAttribute('data-action');
        if(action==='edit-payment'){
          const p=state.payments.find(v=>v.id===id);
          const f=byId('paymentForm'); f.reset();
          f.querySelector('[name="id"]').value=p.id;
          f.querySelector('[name="clientId"]').value=p.clientId||'';
          f.querySelector('[name="company"]').value=p.company||'';
          f.querySelector('[name="contact"]').value=p.contact||'';
          f.querySelector('[name="service"]').value=p.service||'';
          f.querySelector('[name="cost"]').value=p.cost||0;
          f.querySelector('[name="paymentStatus"]').value=p.paymentStatus||'Paid';
          f.querySelector('[name="paymentDate"]').value=p.paymentDate||'';
          f.querySelector('[name="pendingReason"]').value=p.pendingReason||'';
          f.querySelector('[name="serviceStatus"]').value=p.serviceStatus||'Current';
          byId('modal-payment-title').textContent='Edit Payment'; openModal('modal-payment');
        }
        if(action==='delete-payment'){
          if(!confirm('Delete this payment?')) return;
          state.payments = state.payments.filter(v=>v.id!==id);
          toast('Payment deleted'); saveState(); renderPayments(); renderSidebarCounts(); renderDashboard();
        }
      });
      byId('paymentForm').addEventListener('submit', e=>{
        e.preventDefault();
        const fd=new FormData(e.target);
        const id=fd.get('id');
        const clientId=(fd.get('clientId')||'').toString();
        const c=getClient(clientId);
        const obj={
          id: id || ('p'+uid()),
          clientId,
          clientName: c?.name || '',
          company: (fd.get('company')||c?.company||'').toString().trim(),
          contact: (fd.get('contact')||c?.contact||'').toString().trim(),
          service: (fd.get('service')||c?.service||'').toString().trim(),
          cost: Number(fd.get('cost')||c?.cost||0),
          paymentStatus: (fd.get('paymentStatus')||'Paid').toString(),
          paymentDate: (fd.get('paymentDate')||'').toString(),
          pendingReason: (fd.get('pendingReason')||'').toString().trim(),
          serviceStatus: (fd.get('serviceStatus')||'Current').toString()
        };
        if(!obj.clientId && !obj.clientName) return toast('Select a client','warn');
        if(obj.paymentStatus==='Paid' && !obj.paymentDate) obj.paymentDate = new Date().toISOString().slice(0,10);
        if(obj.paymentStatus==='Pending' && !obj.pendingReason) obj.pendingReason = '‚Äî';
        if(id){ const i=state.payments.findIndex(v=>v.id===id); state.payments[i]=obj; toast('Payment updated'); }
        else { state.payments.unshift(obj); toast('Payment added'); }
        saveState(); closeModal('modal-payment'); renderPayments(); renderSidebarCounts(); renderDashboard();
      });
      byId('paymentClientSelect').addEventListener('change', e=>{
        const c=getClient(e.target.value); const f=byId('paymentForm');
        if(c){ f.querySelector('[name="company"]').value=c.company||''; f.querySelector('[name="contact"]').value=c.contact||''; f.querySelector('[name="service"]').value=c.service||''; f.querySelector('[name="cost"]').value=c.cost||0; }
      });

      // Employees
      byId('employeeSearch').addEventListener('input', e=>{ state.filters.employee=e.target.value; renderEmployees(); });
      document.querySelector('#view-employees thead').addEventListener('click', e=>{
        const key=e.target.getAttribute('data-sort'); if(!key) return;
        const s=state.sort.employees; s.dir=(s.key===key && s.dir==='asc')?'desc':'asc'; s.key=key; renderEmployees();
      });
      byId('employeeTableBody').addEventListener('click', e=>{
        const btn=e.target.closest('button[data-action]'); if(!btn) return;
        const id=btn.getAttribute('data-id'); const action=btn.getAttribute('data-action');
        if(action==='edit-employee'){
          const m=state.employees.find(v=>v.id===id);
          const f=byId('employeeForm'); f.reset();
          f.querySelector('[name="id"]').value=m.id;
          f.querySelector('[name="name"]').value=m.name;
          f.querySelector('[name="contact"]').value=m.contact||'';
          f.querySelector('[name="skills"]').value=m.skills||'';
          f.querySelector('[name="clientId"]').value=m.clientId||'';
          byId('modal-employee-title').textContent='Edit Employee'; openModal('modal-employee');
        }
        if(action==='delete-employee'){
          if(!confirm('Delete this employee?')) return;
          state.employees = state.employees.filter(v=>v.id!==id);
          toast('Employee deleted'); saveState(); renderEmployees(); renderSidebarCounts();
        }
      });
      byId('employeeForm').addEventListener('submit', e=>{
        e.preventDefault();
        const fd=new FormData(e.target);
        const id=fd.get('id');
        const obj={
          id: id || ('m'+uid()),
          name: (fd.get('name')||'').toString().trim(),
          contact: (fd.get('contact')||'').toString().trim(),
          skills: (fd.get('skills')||'').toString().trim(),
          clientId: (fd.get('clientId')||'').toString()
        };
        if(!obj.name) return toast('Employee name required','warn');
        if(id){ const i=state.employees.findIndex(v=>v.id===id); state.employees[i]=obj; toast('Employee updated'); }
        else { state.employees.unshift(obj); toast('Employee added'); }
        saveState(); closeModal('modal-employee'); renderEmployees(); renderSidebarCounts();
      });

      // Chart observers
      const chartEl = byId('monthlyChart');
      if(chartEl && chartEl.parentElement){
        const ro = new ResizeObserver(()=> drawMonthlyChart());
        ro.observe(chartEl.parentElement);
      }
      window.addEventListener('resize', ()=> drawMonthlyChart());

      // Persist on refresh
      window.addEventListener('beforeunload', saveState);
    }

    // Init
    function init(){
      // If nothing saved yet, seed defaults so first change persists
      if(!localStorage.getItem(LS_KEY)) {
        localStorage.setItem(LS_KEY, JSON.stringify({
          theme: defaults.theme,
          clients: defaults.clients, expenses: defaults.expenses, payments: defaults.payments, employees: defaults.employees
        }));
      }
      fillClientSelects();
      renderSidebarCounts();
      renderDashboard();
      renderClients();
      renderExpenses();
      renderPayments();
      renderEmployees();
      wire();
      // ensure chart draws after layout
      requestAnimationFrame(()=> requestAnimationFrame(drawMonthlyChart));
    }

    if(document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', init);
    }else{
      init();
    }
  </script>
</body>
</html>