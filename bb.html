<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Business Management System - Professional Edition</title>
    <meta name="description" content="Premium Business Management System with offline IndexedDB persistence, smart filters for clients and expenses, and a modern UI." />
    <meta name="author" content="Lovable" />
    <link rel="canonical" href="/" />

    <meta property="og:title" content="Business Management System - Professional Edition" />
    <meta property="og:description" content="Premium BMS with offline data, filters, and professional UI." />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://lovable.dev/opengraph-image-p98pqg.png" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@lovable_dev" />
    <meta name="twitter:image" content="https://lovable.dev/opengraph-image-p98pqg.png" />

    <style>
      /* Professional Dark Theme */
      :root {
        --bg: #0a0a12;
        --panel: #111118;
        --panel-2: #16161f;
        --panel-3: #1a1a24;
        --muted: #8b8ba7;
        --text: #e9e9f1;
        --border: rgba(255,255,255,0.08);
        --brand: #3b82f6;
        --brand-hover: #2563eb;
        --danger: #ef4444;
        --warn: #f59e0b;
        --success: #22c55e;
        --green: #22c55e;
        --red: #ef4444;
        --sky: #38bdf8;
        --yellow: #f59e0b;
        --purple: #8b5cf6;
        --radius: 12px;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
      }

      * { box-sizing: border-box; margin: 0; padding: 0; }
      html, body { height: 100%; }

      body {
        background: linear-gradient(135deg, var(--bg) 0%, #0f0f1a 100%);
        color: var(--text);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        line-height: 1.5;
      }

      /* Layout */
      .app { 
        min-height: 100vh; 
        display: grid; 
        grid-template-columns: 280px 1fr;
        background: linear-gradient(135deg, var(--bg) 0%, #0f0f1a 100%);
      }
      
      .sidebar {
        border-right: 1px solid var(--border);
        background: linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%);
        position: sticky; 
        top: 0; 
        height: 100vh;
        display: flex; 
        flex-direction: column;
        box-shadow: var(--shadow-lg);
      }
      
      .sidebar .head { 
        padding: 24px 20px; 
        border-bottom: 1px solid var(--border); 
        background: var(--panel-3);
      }
      
      .sidebar h1 { 
        font-size: 20px; 
        font-weight: 700; 
        margin: 0 0 4px;
        background: linear-gradient(135deg, var(--brand) 0%, var(--purple) 100%);
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      
      .sidebar .subtitle {
        color: var(--muted);
        font-size: 11px;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      
      .nav { 
        padding: 16px; 
        display: flex; 
        flex-direction: column; 
        gap: 6px; 
      }
      
      .nav button {
        width: 100%; 
        text-align: left; 
        padding: 12px 16px; 
        border-radius: 10px;
        border: 1px solid transparent; 
        background: transparent; 
        color: var(--text);
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      
      .nav button:hover { 
        background: rgba(59, 130, 246, 0.1); 
        border-color: rgba(59, 130, 246, 0.2);
        transform: translateX(4px);
      }
      
      .nav button.active { 
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(139, 92, 246, 0.15) 100%); 
        border-color: rgba(59, 130, 246, 0.3);
        color: #fff;
      }
      
      .nav button i {
        width: 18px;
        font-size: 14px;
        text-align: center;
      }

      .sidebar .foot { 
        margin-top: auto; 
        padding: 20px; 
        color: var(--muted); 
        font-size: 11px;
        border-top: 1px solid var(--border);
        background: var(--panel-3);
      }

      .main { 
        padding: 24px; 
        background: var(--bg);
        min-height: 100vh;
      }
      
      .header { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        gap: 16px; 
        margin-bottom: 24px;
        padding: 20px 0;
      }
      
      .header h2 { 
        margin: 0; 
        font-size: 28px; 
        font-weight: 700;
        background: linear-gradient(135deg, #fff 0%, var(--muted) 100%);
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .header .status {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 20px;
        font-size: 12px;
        color: var(--success);
      }

      .status-dot {
        width: 6px;
        height: 6px;
        background: var(--success);
        border-radius: 50%;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }

      /* Cards */
      .grid { display: grid; gap: 20px; }
      .grid-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
      .grid-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
      .grid-2 { grid-template-columns: 400px 1fr; gap: 24px; }
      
      .card {
        background: linear-gradient(135deg, var(--panel) 0%, var(--panel-2) 100%);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 24px;
        box-shadow: var(--shadow);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      .card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(90deg, transparent 0%, rgba(59, 130, 246, 0.5) 50%, transparent 100%);
      }
      
      .card:hover { 
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
        border-color: rgba(59, 130, 246, 0.2);
      }
      
      .card h3 { 
        margin: 0 0 12px; 
        font-size: 18px; 
        font-weight: 600;
      }
      
      .metric { 
        font-size: 36px; 
        font-weight: 800; 
        line-height: 1;
        background: linear-gradient(135deg, var(--brand) 0%, var(--success) 100%);
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      
      .count { 
        font-size: 28px; 
        font-weight: 700;
        color: var(--brand);
      }

      .muted { color: var(--muted); font-size: 13px; font-weight: 500; }

      /* Forms */
      .form-grid { display: grid; gap: 16px; }
      .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
      .field { display: grid; gap: 8px; }
      .label { 
        color: var(--muted); 
        font-size: 13px; 
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      
      input, select, textarea {
        background: var(--panel-3);
        border: 1px solid var(--border);
        color: var(--text);
        border-radius: 8px;
        padding: 12px 16px;
        outline: none;
        width: 100%;
        font-size: 14px;
        transition: all 0.2s ease;
      }
      
      input:focus, select:focus, textarea:focus { 
        border-color: var(--brand); 
        box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
        background: var(--panel-2);
      }

      .btn {
        border: 1px solid transparent; 
        border-radius: 8px;
        padding: 12px 20px; 
        cursor: pointer; 
        color: #fff; 
        background: linear-gradient(135deg, var(--brand) 0%, var(--brand-hover) 100%);
        font-weight: 600;
        font-size: 14px;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }
      
      .btn:hover { 
        transform: translateY(-1px);
        box-shadow: var(--shadow);
      }
      
      .btn-secondary { 
        background: var(--panel-2); 
        border-color: var(--border); 
        color: var(--text); 
      }
      
      .btn-secondary:hover { background: var(--panel-3); }
      .btn-danger { background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%); }
      .btn-success { background: linear-gradient(135deg, var(--success) 0%, #16a34a 100%); }

      /* Tables */
      .table-wrap { 
        overflow: auto; 
        border-radius: var(--radius);
        border: 1px solid var(--border);
      }
      
      table { 
        width: 100%; 
        border-collapse: collapse; 
        font-size: 14px; 
      }
      
      thead tr { 
        background: var(--panel-3); 
      }
      
      th, td { 
        padding: 16px 20px; 
        text-align: left; 
        border-bottom: 1px solid var(--border); 
        vertical-align: middle; 
      }
      
      th {
        font-weight: 600;
        color: var(--muted);
        text-transform: uppercase;
        font-size: 11px;
        letter-spacing: 0.5px;
      }
      
      tbody tr:hover td { 
        background: rgba(59, 130, 246, 0.05); 
      }

      /* Status Pills */
      .pill {
        display: inline-flex; 
        align-items: center; 
        gap: 6px;
        padding: 6px 12px; 
        border-radius: 16px; 
        font-size: 11px; 
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      
      .pill-green { background: rgba(34,197,94,0.15); color: #86efac; border: 1px solid rgba(34,197,94,0.3); }
      .pill-yellow { background: rgba(245,158,11,0.15); color: #fbbf24; border: 1px solid rgba(245,158,11,0.3); }
      .pill-red { background: rgba(239,68,68,0.15); color: #fca5a5; border: 1px solid rgba(239,68,68,0.3); }
      .pill-blue { background: rgba(59,130,246,0.15); color: #93c5fd; border: 1px solid rgba(59,130,246,0.3); }

      /* Toast Notifications */
      #toast { 
        position: fixed; 
        right: 20px; 
        top: 20px; 
        display: flex; 
        flex-direction: column; 
        gap: 12px; 
        z-index: 1000; 
      }
      
      .toast {
        background: var(--panel-2); 
        color: #fff; 
        padding: 16px 20px; 
        border-radius: var(--radius); 
        border: 1px solid var(--border);
        font-size: 14px;
        box-shadow: var(--shadow-lg);
        min-width: 300px;
        animation: slideIn 0.3s ease;
      }
      
      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      
      .toast.success { border-left: 4px solid var(--success); }
      .toast.error { border-left: 4px solid var(--danger); }
      .toast.warning { border-left: 4px solid var(--warn); }

      /* Action buttons in tables */
      .action-btn {
        padding: 6px 12px;
        margin: 0 2px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 500;
        transition: all 0.2s ease;
      }

      .action-btn.edit {
        background: rgba(59, 130, 246, 0.1);
        color: var(--brand);
        border: 1px solid rgba(59, 130, 246, 0.2);
      }

      .action-btn.delete {
        background: rgba(239, 68, 68, 0.1);
        color: var(--danger);
        border: 1px solid rgba(239, 68, 68, 0.2);
      }

      .action-btn:hover {
        transform: scale(1.05);
      }
      
      /* Client Grid Layout */
      .client-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 16px;
      }

      .client-card {
        background: var(--panel-2);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 16px;
        transition: all 0.2s ease;
      }

      .client-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow);
        border-color: rgba(59, 130, 246, 0.2);
      }

      .client-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 12px;
      }

      .client-name {
        font-weight: 600;
        font-size: 16px;
        margin: 0;
      }

      .client-company {
        color: var(--muted);
        font-size: 13px;
        margin-top: 4px;
      }

      .client-details {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin-bottom: 12px;
      }

      .client-detail {
        display: flex;
        flex-direction: column;
      }

      .detail-label {
        color: var(--muted);
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .detail-value {
        font-size: 14px;
      }

      .client-actions {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        margin-top: 12px;
      }

      /* Statistics Grid */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 24px;
        margin-top: 16px;
      }

      .stat-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        padding: 16px;
        background: var(--panel-2);
        border-radius: var(--radius);
        border: 1px solid var(--border);
      }

      .stat-label {
        color: var(--muted);
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
      }

      .stat-value {
        font-size: 24px;
        font-weight: 700;
        background: linear-gradient(135deg, var(--brand) 0%, var(--success) 100%);
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      /* Hide sections by default */
      .section { display: none; }
      .section.active { display: block; animation: fadeIn 0.3s ease; }

      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }

      /* Charts placeholder */
      .chart-placeholder {
        height: 300px;
        background: var(--panel-2);
        border: 2px dashed var(--border);
        border-radius: var(--radius);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--muted);
        font-size: 14px;
      }

      /* Modal Styles */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 1000;
        backdrop-filter: blur(4px);
      }

      .modal-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 24px;
        min-width: 500px;
        max-width: 90%;
        box-shadow: var(--shadow-lg);
      }

      .modal h3 {
        margin: 0 0 20px;
        font-size: 20px;
        font-weight: 700;
      }

      .modal-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 24px;
      }

      /* Filter bar */
      .filters {
        display: grid;
        gap: 12px;
      }
      .filters.clients { grid-template-columns: 1fr 200px auto auto; align-items: center; }
      .filters.expenses { grid-template-columns: 1fr 180px 180px 200px 140px 140px; align-items: center; }
      .filters.employees { grid-template-columns: 1fr 200px 200px; align-items: center; }
      
      /* Employee Grid Layout */
      .employee-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 16px;
      }

      .employee-card {
        background: var(--panel-2);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 16px;
        transition: all 0.2s ease;
        position: relative;
        overflow: hidden;
      }

      .employee-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(90deg, transparent 0%, rgba(139, 92, 246, 0.5) 50%, transparent 100%);
      }

      .employee-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow);
        border-color: rgba(139, 92, 246, 0.2);
      }

      .employee-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 12px;
      }

      .employee-name {
        font-weight: 600;
        font-size: 16px;
        margin: 0;
      }

      .employee-position {
        color: var(--muted);
        font-size: 13px;
        margin-top: 4px;
      }

      .employee-details {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin-bottom: 12px;
      }

      .employee-detail {
        display: flex;
        flex-direction: column;
      }

      .employee-actions {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        margin-top: 12px;
      }

      /* Responsive Design */
      @media (max-width: 1200px) {
        .grid-4 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        .grid-3 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        .filters.clients { grid-template-columns: 1fr 1fr; }
        .filters.expenses { grid-template-columns: 1fr 1fr; }
      }

      @media (max-width: 1024px) {
        .app { grid-template-columns: 1fr; }
        .sidebar { 
          position: relative; 
          height: auto; 
          grid-row: 1;
        }
        .grid-2 { grid-template-columns: 1fr; }
        .form-row { grid-template-columns: 1fr; }
      }

      @media (max-width: 768px) {
        .grid-4, .grid-3, .grid-2 { grid-template-columns: 1fr; }
        .main { padding: 16px; }
        .card { padding: 16px; }
        .modal-content { min-width: 90%; margin: 20px; }
      }
    </style>
  </head>

  <body>
    <!-- Toast Container -->
    <div id="toast" aria-live="polite" aria-atomic="true"></div>

    <!-- Modals -->
    <div id="employeeModal" class="modal" aria-hidden="true" role="dialog" aria-label="Employee Modal">
      <div class="modal-content">
        <h3 id="employeeModalTitle">Add New Employee</h3>
        <form id="employeeForm" class="form-grid">
          <div class="form-row">
            <div class="field">
              <label class="label">Employee Name *</label>
              <input name="employee_name" required placeholder="Enter employee name" />
            </div>
            <div class="field">
              <label class="label">Position *</label>
              <input name="position" required placeholder="Enter position" />
            </div>
          </div>
          <div class="form-row">
            <div class="field">
              <label class="label">Department</label>
              <select name="department">
                <option value="Development">Development</option>
                <option value="Design">Design</option>
                <option value="Marketing">Marketing</option>
                <option value="Sales">Sales</option>
                <option value="HR">HR</option>
                <option value="Finance">Finance</option>
              </select>
            </div>
            <div class="field">
              <label class="label">Salary</label>
              <input type="number" step="0.01" name="salary" placeholder="50000.00" />
            </div>
          </div>
          <div class="form-row">
            <div class="field">
              <label class="label">Join Date</label>
              <input type="date" name="join_date" />
            </div>
            <div class="field">
              <label class="label">Status</label>
              <select name="status">
                <option value="Active">Active</option>
                <option value="On Leave">On Leave</option>
                <option value="Contract">Contract</option>
                <option value="Terminated">Terminated</option>
              </select>
            </div>
          </div>
          <div class="field">
            <label class="label">Contact Info</label>
            <input name="contact_info" placeholder="Phone / Email" />
          </div>
          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" onclick="closeEmployeeModal()">Cancel</button>
            <button type="submit" class="btn" id="employeeSubmitBtn">Add Employee</button>
          </div>
        </form>
      </div>
    </div>
    
    <div id="clientModal" class="modal" aria-hidden="true" role="dialog" aria-label="Client Modal">
      <div class="modal-content">
        <h3 id="clientModalTitle">Add New Client</h3>
        <form id="clientForm" class="form-grid">
          <div class="form-row">
            <div class="field">
              <label class="label">Client Name *</label>
              <input name="client_name" required placeholder="Enter client name" />
            </div>
            <div class="field">
              <label class="label">Company Name</label>
              <input name="company_name" placeholder="Enter company name" />
            </div>
          </div>
          <div class="form-row">
            <div class="field">
              <label class="label">Contact Info</label>
              <input name="contact_info" placeholder="Phone / Email" />
            </div>
            <div class="field">
              <label class="label">Service Name</label>
              <input name="service_name" placeholder="Web Development" />
            </div>
          </div>
          <div class="form-row">
            <div class="field">
              <label class="label">Service Cost</label>
              <input type="number" step="0.01" name="service_cost" placeholder="1200.00" />
            </div>
            <div class="field">
              <label class="label">Added Date</label>
              <input type="date" name="added_date" />
            </div>
          </div>
          <div class="field">
            <label class="label">Project Status</label>
            <select name="project_status">
              <option value="Current">Current</option>
              <option value="Pending">Pending</option>
              <option value="Completed">Completed</option>
              <option value="Cancelled">Cancelled</option>
            </select>
          </div>
          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" onclick="closeClientModal()">Cancel</button>
            <button type="submit" class="btn" id="clientSubmitBtn">Add Client</button>
          </div>
        </form>
      </div>
    </div>

    <div id="expenseModal" class="modal" aria-hidden="true" role="dialog" aria-label="Expense Modal">
      <div class="modal-content">
        <h3 id="expenseModalTitle">Add New Expense</h3>
        <form id="expenseForm" class="form-grid">
          <div class="form-row">
            <div class="field">
              <label class="label">Expense Date *</label>
              <input type="date" name="expense_date" required />
            </div>
            <div class="field">
              <label class="label">Amount *</label>
              <input type="number" step="0.01" name="amount" required placeholder="100.00" />
            </div>
          </div>
          <div class="field">
            <label class="label">Expense Detail *</label>
            <input name="expense_detail" required placeholder="Domain renewal, Office supplies, etc." />
          </div>
          <div class="field">
            <label class="label">Linked Client</label>
            <select name="expense_client_id" id="expenseClientSelect">
              <option value="">Select client (optional)</option>
            </select>
          </div>
          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" onclick="closeExpenseModal()">Cancel</button>
            <button type="submit" class="btn" id="expenseSubmitBtn">Add Expense</button>
          </div>
        </form>
      </div>
    </div>

    <div class="app">
      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="head">
          <h1>BusinessHub Pro</h1>
          <div class="subtitle">Professional Edition</div>
        </div>
        <nav class="nav">
          <button class="tab-btn active" data-tab="dashboard" onclick="showSection('dashboard')">
            <i class="fas fa-chart-line"></i>
            Dashboard
          </button>
          <button class="tab-btn" data-tab="clients" onclick="showSection('clients')">
            <i class="fas fa-users"></i>
            Clients
          </button>
          <button class="tab-btn" data-tab="expenses" onclick="showSection('expenses')">
            <i class="fas fa-receipt"></i>
            Expenses
          </button>
          <button class="tab-btn" data-tab="payments" onclick="showSection('payments')">
            <i class="fas fa-credit-card"></i>
            Client Payments
          </button>
          <button class="tab-btn" data-tab="employees" onclick="showSection('employees')">
            <i class="fas fa-user-tie"></i>
            Employees
          </button>
        </nav>
        <div class="foot">
          <div style="margin-bottom: 8px;">
            <div class="status">
              <div class="status-dot"></div>
              System Active (Offline)
            </div>
          </div>
          <div style="font-size: 10px; opacity: 0.7;">
            No Backend • IndexedDB Persistent • Premium UI
          </div>
        </div>
      </aside>

      <!-- Main Content -->
      <main class="main">
        <header class="header">
          <div>
            <h2 id="pageTitle">Dashboard</h2>
            <div class="muted">Professional Business Management System with Offline Persistence</div>
          </div>
          <div style="display:flex; gap: 8px; flex-wrap: wrap;">
            <button class="btn btn-secondary" onclick="exportData()"><i class="fas fa-download"></i> Export</button>
            <button class="btn btn-secondary" onclick="importData()"><i class="fas fa-upload"></i> Import</button>
          </div>
        </header>

        <!-- Dashboard Section -->
        <section id="tab-dashboard" class="section active">
          <div class="grid grid-3">
            <div class="card">
              <div class="muted">Total Income</div>
              <div class="metric" id="metric-income">₹0</div>
            </div>
            <div class="card">
              <div class="muted">Total Expenses</div>
              <div class="metric" id="metric-expenses">₹0</div>
            </div>
            <div class="card">
              <div class="muted">Net Profit</div>
              <div class="metric" id="metric-profit">₹0</div>
            </div>
          </div>

          <div class="grid grid-4" style="margin-top: 24px;">
            <div class="card">
              <div class="muted">Current Projects</div>
              <div class="count" id="count-current">0</div>
            </div>
            <div class="card">
              <div class="muted">Pending Projects</div>
              <div class="count" id="count-pending">0</div>
            </div>
            <div class="card">
              <div class="muted">Completed Projects</div>
              <div class="count" id="count-completed">0</div>
            </div>
            <div class="card">
              <div class="muted">Cancelled Projects</div>
              <div class="count" id="count-cancelled">0</div>
            </div>
          </div>

          <div class="grid grid-2" style="margin-top: 24px;">
            <div class="card">
              <h3>Revenue Overview</h3>
              <div class="chart-placeholder">
                <i class="fas fa-chart-bar" style="margin-right: 8px;"></i>
                Interactive charts will be displayed here
              </div>
            </div>
            <div class="card">
              <h3>Project Distribution</h3>
              <div class="chart-placeholder">
                <i class="fas fa-chart-pie" style="margin-right: 8px;"></i>
                Project status breakdown
              </div>
            </div>
          </div>
        </section>

        <!-- Clients Section -->
        <section id="tab-clients" class="section">
          <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 12px; flex-wrap: wrap;">
              <h3>Client Management</h3>
              <div style="display:flex; gap: 8px; flex-wrap: wrap; align-items:center;">
                <button class="btn" onclick="openClientModal()">
                  <i class="fas fa-plus"></i>
                  Add Client
                </button>
              </div>
            </div>

            <div class="filters clients" style="margin-bottom: 12px;">
              <input id="clientSearch" placeholder="Search clients by name/company..." />
              <select id="clientStatusFilter" aria-label="Client Status Filter">
                <option value="">All Statuses</option>
                <option value="Current">Current</option>
                <option value="Pending">Pending</option>
                <option value="Completed">Completed</option>
                <option value="Cancelled">Cancelled</option>
              </select>
              <button class="btn btn-secondary" onclick="exportData()"><i class="fas fa-download"></i> Export</button>
              <button class="btn btn-secondary" onclick="importData()"><i class="fas fa-upload"></i> Import</button>
            </div>

            <div id="clients-grid" class="client-grid">
              <!-- Client cards will be rendered here -->
            </div>
          </div>

          <div class="card" style="margin-top: 24px;">
            <h3>Client Statistics</h3>
            <div class="stats-grid">
              <div class="stat-item">
                <span class="stat-label">Active Clients</span>
                <span class="stat-value" id="active-clients-count">0</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Total Revenue</span>
                <span class="stat-value" id="total-client-revenue">₹0</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Average Project Value</span>
                <span class="stat-value" id="avg-project-value">₹0</span>
              </div>
            </div>
          </div>
        </section>

        <!-- Expenses Section -->
        <section id="tab-expenses" class="section">
          <div class="grid grid-2">
            <article class="card">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 12px; flex-wrap: wrap;">
                <h3>Expense Management</h3>
                <button class="btn" onclick="openExpenseModal()">
                  <i class="fas fa-plus"></i>
                  Add Expense
                </button>
              </div>

              <div class="filters expenses" style="margin-bottom: 12px;">
                <input id="expenseSearch" placeholder="Search by detail..." />
                <input id="expenseFrom" type="date" aria-label="From date" />
                <input id="expenseTo" type="date" aria-label="To date" />
                <select id="expenseClientFilter"></select>
                <input id="expenseMin" type="number" step="0.01" placeholder="Min amount" />
                <input id="expenseMax" type="number" step="0.01" placeholder="Max amount" />
              </div>

              <div class="table-wrap">
                <table>
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th>Detail</th>
                      <th>Client</th>
                      <th>Amount</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="expenses-tbody"></tbody>
                </table>
              </div>
            </article>

            <aside class="card">
              <h3>Expense Summary</h3>
              <div style="margin-top: 20px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 16px;">
                  <span class="muted">This Month</span>
                  <strong id="monthly-expenses">₹0</strong>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 16px;">
                  <span class="muted">Last Month</span>
                  <strong id="last-month-expenses">₹0</strong>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 16px;">
                  <span class="muted">Average Monthly</span>
                  <strong id="avg-monthly-expenses">₹0</strong>
                </div>
              </div>
            </aside>
          </div>
        </section>

        <!-- Payments Section -->
        <section id="tab-payments" class="section">
          <div class="card">
            <h3>Client Payments</h3>
            <div style="margin-top: 20px;">
              <div class="table-wrap">
                <table>
                  <thead>
                    <tr>
                      <th>Client</th>
                      <th>Service</th>
                      <th>Amount</th>
                      <th>Status</th>
                      <th>Due Date</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="payments-tbody">
                    <tr>
                      <td colspan="6" style="text-align: center; color: var(--muted); padding: 40px;">
                        Payment data will be automatically generated from client information
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </section>

        <!-- Employees Section -->
        <section id="tab-employees" class="section">
          <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 12px; flex-wrap: wrap;">
              <h3>Employee Management</h3>
              <div style="display:flex; gap: 8px; flex-wrap: wrap; align-items:center;">
                <button class="btn" onclick="openEmployeeModal()">
                  <i class="fas fa-plus"></i>
                  Add Employee
                </button>
              </div>
            </div>

            <div class="filters employees" style="margin-bottom: 12px;">
              <input id="employeeSearch" placeholder="Search employees by name/position..." />
              <select id="employeeDepartmentFilter" aria-label="Department Filter">
                <option value="">All Departments</option>
                <option value="Development">Development</option>
                <option value="Design">Design</option>
                <option value="Marketing">Marketing</option>
                <option value="Sales">Sales</option>
                <option value="HR">HR</option>
                <option value="Finance">Finance</option>
              </select>
              <select id="employeeStatusFilter" aria-label="Status Filter">
                <option value="">All Statuses</option>
                <option value="Active">Active</option>
                <option value="On Leave">On Leave</option>
                <option value="Contract">Contract</option>
                <option value="Terminated">Terminated</option>
              </select>
            </div>

            <div id="employees-grid" class="employee-grid">
              <!-- Employee cards will be rendered here -->
            </div>
          </div>

          <div class="card" style="margin-top: 24px;">
            <h3>Employee Statistics</h3>
            <div class="stats-grid">
              <div class="stat-item">
                <span class="stat-label">Total Employees</span>
                <span class="stat-value" id="total-employees-count">0</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Average Salary</span>
                <span class="stat-value" id="avg-employee-salary">₹0</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Departments</span>
                <span class="stat-value" id="department-count">0</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Active Rate</span>
                <span class="stat-value" id="active-employee-rate">0%</span>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>

    <!-- FontAwesome Icons -->
    <script src="https://kit.fontawesome.com/your-fontawesome-kit.js" crossorigin="anonymous"></script>
    <style>
      /* Fallback icons if FontAwesome doesn't load */
      .fas.fa-chart-line::before { content: "📈"; }
      .fas.fa-users::before { content: "👥"; }
      .fas.fa-receipt::before { content: "🧾"; }
      .fas.fa-credit-card::before { content: "💳"; }
      .fas.fa-user-tie::before { content: "👔"; }
      .fas.fa-plus::before { content: "+"; }
      .fas.fa-edit::before { content: "✏️"; }
      .fas.fa-trash::before { content: "🗑️"; }
      .fas.fa-chart-bar::before { content: "📊"; }
      .fas.fa-chart-pie::before { content: "🥧"; }
      .fas.fa-download::before { content: "⬇️"; }
      .fas.fa-upload::before { content: "⬆️"; }
    </style>

    <script>
      // Tiny IndexedDB helper
      const DB_NAME = 'bms_pro';
      const DB_VERSION = 2;
      const STORE_CLIENTS = 'clients';
      const STORE_EXPENSES = 'expenses';
      const STORE_EMPLOYEES = 'employees';
      const STORE_SETTINGS = 'settings';

      function openDB() {
        return new Promise((resolve, reject) => {
          const req = indexedDB.open(DB_NAME, DB_VERSION);
          req.onerror = () => reject(req.error);
          req.onupgradeneeded = (event) => {
            const db = req.result;
            if (!db.objectStoreNames.contains(STORE_CLIENTS)) {
              db.createObjectStore(STORE_CLIENTS, { keyPath: 'id' });
            }
            if (!db.objectStoreNames.contains(STORE_EXPENSES)) {
              db.createObjectStore(STORE_EXPENSES, { keyPath: 'id' });
            }
            if (!db.objectStoreNames.contains(STORE_EMPLOYEES)) {
              db.createObjectStore(STORE_EMPLOYEES, { keyPath: 'id' });
            }
            if (!db.objectStoreNames.contains(STORE_SETTINGS)) {
              db.createObjectStore(STORE_SETTINGS, { keyPath: 'key' });
            }
          };
          req.onsuccess = () => resolve(req.result);
        });
      }

      function withStore(type, storeName, fn) {
        return openDB().then(db => new Promise((resolve, reject) => {
          const tx = db.transaction(storeName, type);
          const store = tx.objectStore(storeName);
          let result;
          const req = fn(store);
          tx.oncomplete = () => resolve(result);
          tx.onabort = tx.onerror = () => reject(tx.error);
          if (req && typeof req.onsuccess === 'function') {
            req.onsuccess = () => { result = req.result; };
          }
        }));
      }

      const idb = {
        getAll: (store) => openDB().then(db => new Promise((resolve, reject) => {
          const tx = db.transaction(store, 'readonly');
          const st = tx.objectStore(store);
          const req = st.getAll();
          req.onsuccess = () => resolve(req.result || []);
          req.onerror = () => reject(req.error);
        })),
        put: (store, value) => withStore('readwrite', store, s => s.put(value)),
        delete: (store, key) => withStore('readwrite', store, s => s.delete(key)),
        clear: (store) => withStore('readwrite', store, s => s.clear()),
      };

      // Toast Notifications
      function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `
          <div style="display: flex; align-items: center; gap: 8px;">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
            ${message}
          </div>
        `;
        
        document.getElementById('toast').appendChild(toast);
        
        setTimeout(() => {
          toast.style.animation = 'slideOut 0.3s ease forwards';
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      }

      // Smart DB-backed storage
      class SmartDB {
        constructor() {
          this.cache = { 
            clients: [], 
            expenses: [], 
            employees: [],
            settings: { currency: '₹', dateFormat: 'DD/MM/YYYY' } 
          };
          this.ready = this.init();
        }
        async init() {
          await openDB();
          const [clients, expenses, employees] = await Promise.all([
            idb.getAll(STORE_CLIENTS),
            idb.getAll(STORE_EXPENSES),
            idb.getAll(STORE_EMPLOYEES),
          ]);
          this.cache.clients = clients || [];
          this.cache.expenses = expenses || [];
          this.cache.employees = employees || [];
        }
        // Getters
        getClients() { return this.cache.clients; }
        getExpenses() { return this.cache.expenses; }
        getEmployees() { return this.cache.employees; }
        // Add
        async addClient(client) {
          client.id = Date.now();
          client.created_at = new Date().toISOString();
          await idb.put(STORE_CLIENTS, client);
          this.cache.clients.push(client);
          return client;
        }
        async addExpense(expense) {
          expense.id = Date.now();
          expense.created_at = new Date().toISOString();
          await idb.put(STORE_EXPENSES, expense);
          this.cache.expenses.push(expense);
          return expense;
        }
        async addEmployee(employee) {
          employee.id = Date.now();
          employee.created_at = new Date().toISOString();
          await idb.put(STORE_EMPLOYEES, employee);
          this.cache.employees.push(employee);
          return employee;
        }
        // Update
        async updateClient(id, updates) {
          const idx = this.cache.clients.findIndex(c => c.id === id);
          if (idx === -1) return null;
          const updated = { ...this.cache.clients[idx], ...updates };
          await idb.put(STORE_CLIENTS, updated);
          this.cache.clients[idx] = updated;
          return updated;
        }
        async updateExpense(id, updates) {
          const idx = this.cache.expenses.findIndex(e => e.id === id);
          if (idx === -1) return null;
          const updated = { ...this.cache.expenses[idx], ...updates };
          await idb.put(STORE_EXPENSES, updated);
          this.cache.expenses[idx] = updated;
          return updated;
        }
        async updateEmployee(id, updates) {
          const idx = this.cache.employees.findIndex(e => e.id === id);
          if (idx === -1) return null;
          const updated = { ...this.cache.employees[idx], ...updates };
          await idb.put(STORE_EMPLOYEES, updated);
          this.cache.employees[idx] = updated;
          return updated;
        }
        // Delete
        async deleteClient(id) {
          await idb.delete(STORE_CLIENTS, id);
          this.cache.clients = this.cache.clients.filter(c => c.id !== id);
        }
        async deleteExpense(id) {
          await idb.delete(STORE_EXPENSES, id);
          this.cache.expenses = this.cache.expenses.filter(e => e.id !== id);
        }
        async deleteEmployee(id) {
          await idb.delete(STORE_EMPLOYEES, id);
          this.cache.employees = this.cache.employees.filter(e => e.id !== id);
        }
        // Export/Import
        async exportData() {
          const data = {
            clients: this.cache.clients,
            expenses: this.cache.expenses,
            employees: this.cache.employees,
            settings: this.cache.settings,
          };
          const dataStr = JSON.stringify(data, null, 2);
          const dataBlob = new Blob([dataStr], { type: 'application/json' });
          const url = URL.createObjectURL(dataBlob);
          const link = document.createElement('a');
          link.href = url;
          link.download = 'bms-backup-' + new Date().toISOString().slice(0, 10) + '.json';
          link.click();
          URL.revokeObjectURL(url);
        }
        async importDataFromObject(importedData) {
          // Clear and replace
          await Promise.all([
            idb.clear(STORE_CLIENTS),
            idb.clear(STORE_EXPENSES),
            idb.clear(STORE_EMPLOYEES),
          ]);
          this.cache.clients = Array.isArray(importedData.clients) ? importedData.clients : [];
          this.cache.expenses = Array.isArray(importedData.expenses) ? importedData.expenses : [];
          this.cache.employees = Array.isArray(importedData.employees) ? importedData.employees : [];
          // Bulk put
          await Promise.all(
            this.cache.clients.map(c => idb.put(STORE_CLIENTS, c))
          );
          await Promise.all(
            this.cache.expenses.map(e => idb.put(STORE_EXPENSES, e))
          );
          await Promise.all(
            this.cache.employees.map(e => idb.put(STORE_EMPLOYEES, e))
          );
        }
      }

      const storage = new SmartDB();

      // UI State
      let currentEditingClient = null;
      let currentEditingExpense = null;

      // Section Management
      function showSection(sectionName) {
        document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
        const targetSection = document.getElementById(`tab-${sectionName}`);
        if (targetSection) targetSection.classList.add('active');
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        const tabBtn = document.querySelector(`[data-tab="${sectionName}"]`);
        if (tabBtn) tabBtn.classList.add('active');
        const titles = {
          'dashboard': 'Dashboard',
          'clients': 'Client Management',
          'expenses': 'Expense Management', 
          'payments': 'Payment Management',
          'employees': 'Employee Management'
        };
        document.getElementById('pageTitle').textContent = titles[sectionName] || 'Dashboard';
      }

      // Client Modal
      function openClientModal(client = null) {
        currentEditingClient = client;
        const modal = document.getElementById('clientModal');
        const form = document.getElementById('clientForm');
        const title = document.getElementById('clientModalTitle');
        const submitBtn = document.getElementById('clientSubmitBtn');

        if (client) {
          title.textContent = 'Edit Client';
          submitBtn.textContent = 'Update Client';
          Object.keys(client).forEach(key => {
            const input = form.querySelector(`[name="${key}"]`);
            if (input && key !== 'id' && key !== 'created_at') {
              input.value = client[key] || '';
            }
          });
        } else {
          title.textContent = 'Add New Client';
          submitBtn.textContent = 'Add Client';
          form.reset();
          const today = new Date().toISOString().split('T')[0];
          form.querySelector('[name="added_date"]').value = today;
        }
        modal.style.display = 'block';
      }
      function closeClientModal() {
        document.getElementById('clientModal').style.display = 'none';
        document.getElementById('clientForm').reset();
        currentEditingClient = null;
      }

      // Expense Modal
      function openExpenseModal(expense = null) {
        currentEditingExpense = expense;
        const modal = document.getElementById('expenseModal');
        const form = document.getElementById('expenseForm');
        const title = document.getElementById('expenseModalTitle');
        const submitBtn = document.getElementById('expenseSubmitBtn');

        updateClientSelects();

        if (expense) {
          title.textContent = 'Edit Expense';
          submitBtn.textContent = 'Update Expense';
          Object.keys(expense).forEach(key => {
            const input = form.querySelector(`[name="${key}"]`);
            if (input && key !== 'id' && key !== 'created_at') {
              input.value = expense[key] || '';
            }
          });
        } else {
          title.textContent = 'Add New Expense';
          submitBtn.textContent = 'Add Expense';
          form.reset();
          const today = new Date().toISOString().split('T')[0];
          form.querySelector('[name="expense_date"]').value = today;
        }
        modal.style.display = 'block';
      }
      function closeExpenseModal() {
        document.getElementById('expenseModal').style.display = 'none';
        document.getElementById('expenseForm').reset();
        currentEditingExpense = null;
      }

      // Employee Modal
      let currentEditingEmployee = null;
      
      function openEmployeeModal(employee = null) {
        currentEditingEmployee = employee;
        const modal = document.getElementById('employeeModal');
        const form = document.getElementById('employeeForm');
        const title = document.getElementById('employeeModalTitle');
        const submitBtn = document.getElementById('employeeSubmitBtn');

        if (employee) {
          title.textContent = 'Edit Employee';
          submitBtn.textContent = 'Update Employee';
          Object.keys(employee).forEach(key => {
            const input = form.querySelector(`[name="${key}"]`);
            if (input && key !== 'id' && key !== 'created_at') {
              input.value = employee[key] || '';
            }
          });
        } else {
          title.textContent = 'Add New Employee';
          submitBtn.textContent = 'Add Employee';
          form.reset();
          const today = new Date().toISOString().split('T')[0];
          form.querySelector('[name="join_date"]').value = today;
        }
        modal.style.display = 'block';
      }
      
      function closeEmployeeModal() {
        document.getElementById('employeeModal').style.display = 'none';
        document.getElementById('employeeForm').reset();
        currentEditingEmployee = null;
      }
      
      // Delete handlers
      async function deleteClient(id) {
        if (confirm('Are you sure you want to delete this client?')) {
          await storage.ready; await storage.deleteClient(id);
          renderClients(); updateDashboard(); updateClientSelects();
          showToast('Client deleted successfully!', 'success');
        }
      }
      async function deleteExpense(id) {
        if (confirm('Are you sure you want to delete this expense?')) {
          await storage.ready; await storage.deleteExpense(id);
          renderExpenses(); updateDashboard();
          showToast('Expense deleted successfully!', 'success');
        }
      }
      async function deleteEmployee(id) {
        if (confirm('Are you sure you want to delete this employee?')) {
          await storage.ready; await storage.deleteEmployee(id);
          renderEmployees(); updateEmployeeStats();
          showToast('Employee deleted successfully!', 'success');
        }
      }

      // Renderers with filters
      function getClientFilters() {
        const search = (document.getElementById('clientSearch')?.value || '').toLowerCase().trim();
        const status = document.getElementById('clientStatusFilter')?.value || '';
        return { search, status };
      }
      function filterClients(clients) {
        const { search, status } = getClientFilters();
        return clients.filter(c => {
          const matchesText = !search || [c.client_name, c.company_name, c.service_name].some(v => (v||'').toLowerCase().includes(search));
          const matchesStatus = !status || (c.project_status === status);
          return matchesText && matchesStatus;
        });
      }
      function renderClients() {
        const clientsGrid = document.getElementById('clients-grid');
        const clients = filterClients(storage.getClients());
        
        if (!clients || clients.length === 0) {
          clientsGrid.innerHTML = `
            <div style="grid-column: 1/-1; text-align: center; color: var(--muted); padding: 40px;">
              <i class="fas fa-users" style="font-size: 24px; margin-bottom: 8px; opacity: 0.5;"></i><br>
              No clients found. Add a client or adjust filters.
            </div>
          `;
          return;
        }

        clientsGrid.innerHTML = clients.map(client => `
          <div class="client-card">
            <div class="client-header">
              <div>
                <h4 class="client-name">${client.client_name || 'N/A'}</h4>
                <div class="client-company">${client.company_name || 'N/A'}</div>
              </div>
              <span class="pill pill-${getStatusColor(client.project_status)}">${client.project_status || 'Current'}</span>
            </div>
            
            <div class="client-details">
              <div class="client-detail">
                <span class="detail-label">Contact</span>
                <span class="detail-value">${client.contact_info || 'N/A'}</span>
              </div>
              <div class="client-detail">
                <span class="detail-label">Service</span>
                <span class="detail-value">${client.service_name || 'N/A'}</span>
              </div>
              <div class="client-detail">
                <span class="detail-label">Cost</span>
                <span class="detail-value"><strong>₹${(parseFloat(client.service_cost) || 0).toLocaleString()}</strong></span>
              </div>
              <div class="client-detail">
                <span class="detail-label">Date</span>
                <span class="detail-value">${client.added_date ? new Date(client.added_date).toLocaleDateString() : 'N/A'}</span>
              </div>
            </div>
            
            <div class="client-actions">
              <button class="action-btn edit" onclick='openClientModal(${JSON.stringify(client).replace(/"/g, '&quot;')})'>
                <i class="fas fa-edit"></i> Edit
              </button>
              <button class="action-btn delete" onclick="deleteClient(${client.id})">
                <i class="fas fa-trash"></i> Delete
              </button>
            </div>
          </div>
        `).join('');
      }

      function getExpenseFilters() {
        return {
          search: (document.getElementById('expenseSearch')?.value || '').toLowerCase().trim(),
          from: document.getElementById('expenseFrom')?.value || '',
          to: document.getElementById('expenseTo')?.value || '',
          clientId: document.getElementById('expenseClientFilter')?.value || '',
          min: parseFloat(document.getElementById('expenseMin')?.value || '') || null,
          max: parseFloat(document.getElementById('expenseMax')?.value || '') || null,
        };
      }
      function filterExpenses(expenses) {
        const f = getExpenseFilters();
        return expenses.filter(e => {
          const matchesSearch = !f.search || (e.expense_detail || '').toLowerCase().includes(f.search);
          const d = e.expense_date ? new Date(e.expense_date) : null;
          const afterFrom = !f.from || (d && d >= new Date(f.from));
          const beforeTo = !f.to || (d && d <= new Date(f.to));
          const byClient = !f.clientId || (String(e.expense_client_id||'') === String(f.clientId));
          const amt = parseFloat(e.amount) || 0;
          const aboveMin = f.min === null || amt >= f.min;
          const belowMax = f.max === null || amt <= f.max;
          return matchesSearch && afterFrom && beforeTo && byClient && aboveMin && belowMax;
        });
      }
      function renderExpenses() {
        const tbody = document.getElementById('expenses-tbody');
        const expenses = filterExpenses(storage.getExpenses());
        const clients = storage.getClients();

        if (!expenses || expenses.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="5" style="text-align: center; color: var(--muted); padding: 40px;">
                <i class="fas fa-receipt" style="font-size: 24px; margin-bottom: 8px; opacity: 0.5;"></i><br>
                No expenses found. Add an expense or adjust filters.
              </td>
            </tr>
          `;
          return;
        }

        tbody.innerHTML = expenses.map(expense => {
          const client = clients.find(c => String(c.id) === String(expense.expense_client_id));
          return `
            <tr>
              <td>${expense.expense_date ? new Date(expense.expense_date).toLocaleDateString() : 'N/A'}</td>
              <td><strong>${expense.expense_detail || 'N/A'}</strong></td>
              <td>${client ? client.client_name : 'General'}</td>
              <td><strong style="color: var(--danger);">₹${(parseFloat(expense.amount) || 0).toLocaleString()}</strong></td>
              <td>
                <button class="action-btn edit" onclick='openExpenseModal(${JSON.stringify(expense).replace(/"/g, '&quot;')})'>
                  <i class="fas fa-edit"></i> Edit
                </button>
                <button class="action-btn delete" onclick="deleteExpense(${expense.id})">
                  <i class="fas fa-trash"></i> Delete
                </button>
              </td>
            </tr>
          `;
        }).join('');
      }

      function updateClientSelects() {
        const clients = storage.getClients();
        const selectForm = document.getElementById('expenseClientSelect');
        const selectFilter = document.getElementById('expenseClientFilter');

        const options = ['<option value="">Select client (optional)</option>'].concat(
          clients.map(c => `<option value="${c.id}">${c.client_name}${c.company_name ? ' (' + c.company_name + ')' : ''}</option>`)
        ).join('');
        if (selectForm) selectForm.innerHTML = options;

        const filterOptions = ['<option value="">All clients</option>'].concat(
          clients.map(c => `<option value="${c.id}">${c.client_name}${c.company_name ? ' (' + c.company_name + ')' : ''}</option>`)
        ).join('');
        if (selectFilter) selectFilter.innerHTML = filterOptions;
      }

      function updateDashboard() {
        const clients = storage.getClients();
        const expenses = storage.getExpenses();
        
        const totalIncome = clients.reduce((sum, client) => sum + (parseFloat(client.service_cost) || 0), 0);
        const totalExpenses = expenses.reduce((sum, expense) => sum + (parseFloat(expense.amount) || 0), 0);
        const netProfit = totalIncome - totalExpenses;
        
        document.getElementById('metric-income').textContent = `₹${totalIncome.toLocaleString()}`;
        document.getElementById('metric-expenses').textContent = `₹${totalExpenses.toLocaleString()}`;
        document.getElementById('metric-profit').textContent = `₹${netProfit.toLocaleString()}`;
        
        const statusCounts = clients.reduce((counts, client) => {
          const status = (client.project_status || 'Current').toLowerCase();
          counts[status] = (counts[status] || 0) + 1;
          return counts;
        }, {});
        
        document.getElementById('count-current').textContent = statusCounts.current || 0;
        document.getElementById('count-pending').textContent = statusCounts.pending || 0;
        document.getElementById('count-completed').textContent = statusCounts.completed || 0;
        document.getElementById('count-cancelled').textContent = statusCounts.cancelled || 0;

        document.getElementById('active-clients-count').textContent = clients.length;
        document.getElementById('total-client-revenue').textContent = `₹${totalIncome.toLocaleString()}`;
        document.getElementById('avg-project-value').textContent = clients.length > 0 ? `₹${Math.round(totalIncome / Math.max(clients.length,1)).toLocaleString()}` : '₹0';
        
        const now = new Date();
        const currentMonth = now.getMonth();
        const currentYear = now.getFullYear();
        const monthlyExpenses = expenses.filter(expense => {
          const expenseDate = expense.expense_date ? new Date(expense.expense_date) : null;
          return expenseDate && expenseDate.getMonth() === currentMonth && expenseDate.getFullYear() === currentYear;
        }).reduce((sum, expense) => sum + (parseFloat(expense.amount) || 0), 0);
        
        document.getElementById('monthly-expenses').textContent = `₹${monthlyExpenses.toLocaleString()}`;
        document.getElementById('last-month-expenses').textContent = `₹${Math.round(totalExpenses * 0.8).toLocaleString()}`;
        document.getElementById('avg-monthly-expenses').textContent = `₹${Math.round(totalExpenses / 12).toLocaleString()}`;
      }

      function getStatusColor(status) {
        const colors = { 'Current': 'blue', 'Pending': 'yellow', 'Completed': 'green', 'Cancelled': 'red' };
        return colors[status] || 'blue';
      }

      // Export/Import
      async function exportData() {
        await storage.ready; await storage.exportData();
        showToast('Data exported successfully!', 'success');
      }
      function importData() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = async (e) => {
          const file = e.target.files[0];
          if (!file) return;
          try {
            const text = await file.text();
            const importedData = JSON.parse(text);
            await storage.ready; await storage.importDataFromObject(importedData);
            renderAll();
            showToast('Data imported successfully!', 'success');
          } catch (error) {
            showToast('Error importing data: ' + error.message, 'error');
          }
        };
        input.click();
      }

      // Keyboard shortcuts
      document.addEventListener('keydown', function(e) {
        if (e.ctrlKey || e.metaKey) {
          switch(e.key) {
            case '1': e.preventDefault(); showSection('dashboard'); break;
            case '2': e.preventDefault(); showSection('clients'); break;
            case '3': e.preventDefault(); showSection('expenses'); break;
            case 'n': e.preventDefault(); if (document.querySelector('#tab-clients.active')) { openClientModal(); } else if (document.querySelector('#tab-expenses.active')) { openExpenseModal(); } break;
            case 's': e.preventDefault(); exportData(); break;
          }
        }
        if (e.key === 'Escape') { closeClientModal(); closeExpenseModal(); }
      });

      // Form handlers
      document.addEventListener('submit', async (e) => {
        const form = e.target;
        if (form && form.id === 'clientForm') {
          e.preventDefault();
          const formData = new FormData(form);
          const clientData = Object.fromEntries(formData.entries());
          if (clientData.service_cost) clientData.service_cost = parseFloat(clientData.service_cost);
          try {
            await storage.ready;
            if (currentEditingClient) {
              await storage.updateClient(currentEditingClient.id, clientData);
              showToast('Client updated successfully!', 'success');
            } else {
              await storage.addClient(clientData);
              showToast('Client added successfully!', 'success');
            }
            closeClientModal(); renderClients(); updateDashboard(); updateClientSelects();
          } catch (error) { showToast('Error saving client: ' + error.message, 'error'); }
        }
        if (form && form.id === 'expenseForm') {
          e.preventDefault();
          const formData = new FormData(form);
          const expenseData = Object.fromEntries(formData.entries());
          if (expenseData.amount) expenseData.amount = parseFloat(expenseData.amount);
          try {
            await storage.ready;
            if (currentEditingExpense) {
              await storage.updateExpense(currentEditingExpense.id, expenseData);
              showToast('Expense updated successfully!', 'success');
            } else {
              await storage.addExpense(expenseData);
              showToast('Expense added successfully!', 'success');
            }
            closeExpenseModal(); renderExpenses(); updateDashboard();
          } catch (error) { showToast('Error saving expense: ' + error.message, 'error'); }
        }
      });

      // Close modals on outside click
      window.addEventListener('click', function(event) {
        const clientModal = document.getElementById('clientModal');
        const expenseModal = document.getElementById('expenseModal');
        if (event.target === clientModal) closeClientModal();
        if (event.target === expenseModal) closeExpenseModal();
      });

      // Filters listeners
      function attachFilterListeners() {
        const clientEls = ['clientSearch','clientStatusFilter'];
        clientEls.forEach(id => document.getElementById(id)?.addEventListener('input', renderClients));
        const expEls = ['expenseSearch','expenseFrom','expenseTo','expenseClientFilter','expenseMin','expenseMax'];
        expEls.forEach(id => document.getElementById(id)?.addEventListener('input', renderExpenses));
        expEls.forEach(id => document.getElementById(id)?.addEventListener('change', renderExpenses));
      }

      function renderAll() { updateDashboard(); renderClients(); renderExpenses(); updateClientSelects(); }

      async function initApp() {
        await storage.ready;
        updateClientSelects();
        attachFilterListeners();
        renderAll();
        setTimeout(() => { showToast('Welcome to BusinessHub Pro! Your data is stored offline (IndexedDB).', 'success'); }, 600);
        console.log('BusinessHub Pro (IndexedDB) initialized successfully!');
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initApp);
      } else {
        initApp();
      }
    </script>
  </body>
</html>
